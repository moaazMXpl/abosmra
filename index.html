






<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø© - Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</title>
  <style>
    :root {
      --bg: #1a1410;
      --card: #2d2419;
      --muted: #a89175;
      --accent: #d4a03a;
      --gold: #f4c430;
      --brown: #5c4532;
      --brown-dark: #3d2e1f;
      --success: #7c9b3e;
      --danger: #c4402e;
    }
    * {
      box-sizing: border-box;
    }
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: #f5f1e8;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--brown) 0%, var(--brown-dark) 100%);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .profile-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .profile-btn:hover {
      transform: scale(1.1);
    }
    /* Categories horizontal scroll */
    .categories-section {
      background: var(--card);
      padding: 16px 0;
      border-bottom: 2px solid var(--accent);
      position: sticky;
      top: 76px;
      z-index: 99;
    }
    .categories-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 0 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--brown-dark);
    }
    .categories-scroll::-webkit-scrollbar {
      height: 6px;
    }
    .categories-scroll::-webkit-scrollbar-track {
      background: var(--brown-dark);
    }
    .categories-scroll::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    .category-btn {
      padding: 10px 20px;
      border-radius: 25px;
      background: var(--brown);
      color: #f5f1e8;
      border: 2px solid transparent;
      cursor: pointer;
      white-space: nowrap;
      font-weight: bold;
      transition: all 0.3s;
    }
    .category-btn:hover,
    .category-btn.active {
      background: var(--accent);
      border-color: var(--gold);
      color: #1a1410;
      transform: translateY(-2px);
    }
    /* Menu */
    .menu-container {
      padding: 20px;
    }
    .menu-section {
      margin-bottom: 40px;
      scroll-margin-top: 150px;
    }
    .section-title {
      background: linear-gradient(135deg, var(--gold) 0%, var(--accent) 100%);
      color: #1a1410;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: bold;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(244, 196, 48, 0.3);
    }
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    .menu-item {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .menu-item:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(244, 196, 48, 0.2);
    }
    .menu-item h4 {
      margin: 0 0 8px 0;
      color: var(--gold);
      font-size: 1.1rem;
    }
    .price {
      color: var(--accent);
      font-weight: bold;
      font-size: 1.2rem;
      margin: 8px 0;
    }
    .add-cart-btn {
      width: 100%;
      padding: 10px;
      background: var(--success);
      color: #fff;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .add-cart-btn:hover {
      background: #6a8435;
      transform: scale(1.05);
    }
    .add-cart-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }
    /* Cart Panel */
    .cart-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      color: #1a1410;
      border: 3px solid var(--gold);
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 16px rgba(244, 196, 48, 0.4);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .cart-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .cart-panel {
      position: fixed;
      top: 0;
      left: -100%;
      width: 100%;
      max-width: 400px;
      height: 100vh;
      background: var(--card);
      padding: 20px;
      transition: left 0.3s;
      z-index: 10000;
      overflow-y: auto;
      box-shadow: 4px 0 20px rgba(0,0,0,0.5);
    }
    .cart-panel.open {
      left: 0;
    }
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--accent);
    }
    .cart-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--gold);
    }
    .close-cart {
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
    }
    .cart-items {
      margin-bottom: 20px;
    }
    .cart-item {
      background: var(--brown-dark);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-total {
      background: var(--gold);
      color: #1a1410;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      margin: 16px 0;
    }
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary {
      background: var(--success);
      color: #fff;
    }
    .btn-primary:hover {
      background: #6a8435;
    }
    .btn-secondary {
      background: var(--brown);
      color: #f5f1e8;
    }
    .btn-secondary:hover {
      background: var(--brown-dark);
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    /* Profile Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    }
    .modal.open {
      display: flex;
    }
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid var(--accent);
    }
    .modal-title {
      color: var(--gold);
      font-size: 1.5rem;
      margin-bottom: 16px;
      text-align: center;
    }
    .input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid var(--brown);
      background: var(--brown-dark);
      color: #f5f1e8;
      margin-bottom: 12px;
      font-size: 1rem;
    }
    .input:focus {
      outline: none;
      border-color: var(--accent);
    }
    select.input {
      cursor: pointer;
    }
    textarea.input {
      min-height: 80px;
      resize: vertical;
    }
    /* Checkout */
    .checkout-section {
      display: none;
      padding: 20px;
      background: var(--card);
      margin: 20px;
      border-radius: 12px;
      border: 2px solid var(--accent);
    }
    /* Operator Dashboard */
    .operator-dashboard {
      display: none;
      padding: 20px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 24px;
      background: var(--brown);
      color: #f5f1e8;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab.active {
      background: var(--accent);
      color: #1a1410;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .order-card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .order-card:hover {
      border-color: var(--accent);
    }
    .order-details {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: var(--brown-dark);
      border-radius: 8px;
    }
    .order-details.open {
      display: block;
    }
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .badge-received {
      background: #3b82f6;
      color: #fff;
    }
    .badge-preparing {
      background: #f59e0b;
      color: #1a1410;
    }
    .badge-ready {
      background: var(--success);
      color: #fff;
    }
    .badge-delivered {
      background: #6b7280;
      color: #fff;
    }
    /* Notifications */
    .notification {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      display: none;
      z-index: 10002;
      animation: slideUp 0.3s;
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    .notification.error {
      background: var(--danger);
    }
    .notification.warning {
      background: #f59e0b;
      color: #1a1410;
    }
    /* Customer Order Status */
    .customer-status {
      background: var(--card);
      padding: 20px;
      margin: 20px;
      border-radius: 12px;
      border: 2px solid var(--accent);
      display: none;
    }
    .customer-status.show {
      display: block;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* Search */
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar .input {
      flex: 1;
      min-width: 200px;
    }
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--gold);
      margin: 8px 0;
    }
    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .small {
      font-size: 0.9rem;
      color: var(--muted);
    }
    @media (max-width: 768px) {
      .menu-grid {
        grid-template-columns: 1fr;
      }
      .cart-panel {
        max-width: 100%;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <h1>ğŸ› ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©</h1>
    </div>
    <div class="header-actions">
      <button class="profile-btn" id="profileBtn">ğŸ‘¤</button>
    </div>
  </div>

  <!-- Categories -->
  <div class="categories-section">
    <div class="categories-scroll" id="categoriesScroll"></div>
  </div>

  <!-- Customer Status Notification -->
  <div class="customer-status" id="customerStatus">
    <h3 style="color: var(--gold); margin-top: 0;">Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</h3>
    <div id="statusContent"></div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="menu-container" id="menuContainer"></div>
  </div>

  <!-- Cart Toggle Button -->
  <button class="cart-toggle" id="cartToggle">
    ğŸ›’
    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
  </button>

  <!-- Cart Panel -->
  <div class="cart-panel" id="cartPanel">
    <div class="cart-header">
      <div class="cart-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
      <button class="close-cart" id="closeCart">Ã—</button>
    </div>
    <div class="small" id="cartCustomerInfo">Ø¶ÙŠÙ â€” Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯</div>
    <div class="cart-items" id="cartItems">
      <div class="small" style="text-align: center; padding: 20px; color: var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
    </div>
    <div style="margin: 16px 0;">
      <label class="small">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <select id="applyOffer" class="input"></select>
    </div>
    <div class="cart-total" id="cartTotal">0 Ø¬</div>
    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
      <button class="btn btn-primary" id="checkoutBtn" style="flex: 1;">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn btn-secondary" id="clearCartBtn">ØªÙØ±ÙŠØº</button>
    </div>
    <div class="small" style="text-align: center;">Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</div>
  </div>

  <!-- Checkout Section -->
  <div class="checkout-section" id="checkoutSection">
    <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø¯ÙØ¹</div>
    <input id="orderName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />
    <input id="orderPhone" class="input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
    <input id="orderAddress" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ØªÙØµÙŠÙ„)" />
    <select id="orderPayment" class="input">
      <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
      <option value="vodafone">ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
      <option value="card">Ø¨Ø·Ø§Ù‚Ø© (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
      <option value="fawry">ÙÙˆØ±ÙŠ (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
    </select>
    <textarea id="orderNotes" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    <div style="display: flex; gap: 8px; margin-top: 16px;">
      <button class="btn btn-primary" id="confirmOrderBtn" style="flex: 1;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn btn-secondary" id="cancelCheckoutBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <button class="btn btn-secondary" id="customerViewBtn" style="width: 100%; margin-bottom: 12px;">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
      <button class="btn btn-secondary" id="operatorLoginBtn" style="width: 100%; margin-bottom: 12px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„</button>
      <button class="btn btn-secondary" id="closeProfileBtn" style="width: 100%;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Operator Login Modal -->
  <div class="modal" id="operatorModal">
    <div class="modal-content">
      <div class="modal-title">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„</div>
      <input id="operatorPassword" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn btn-primary" id="submitOperatorBtn" style="flex: 1;">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" id="cancelOperatorBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Operator Dashboard -->
  <div class="operator-dashboard" id="operatorDashboard">
    <div class="header" style="position: relative; top: 0;">
      <div class="brand">
        <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´ØºÙ„</h1>
      </div>
      <button class="btn btn-danger" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
    <div style="padding: 20px;">
      <div class="tabs">
        <button class="tab active" data-tab="orders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="tab" data-tab="history">Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</button>
        <button class="tab" data-tab="epot">EPOT</button>
      </div>
      <div class="tab-content active" id="ordersContent">
        <div id="ordersGrid"></div>
      </div>
      <div class="tab-content" id="historyContent">
        <div class="section-title">Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="search-bar">
          <input class="input" id="searchAddress" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
          <input class="input" id="searchPhone" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <input class="input" id="searchOrderId" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ†" />
          <input class="input" id="searchName" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <button class="btn btn-primary" id="searchBtn">Ø¨Ø­Ø«</button>
        </div>
        <div id="historyGrid"></div>
      </div>
      <div class="tab-content" id="epotContent">
        <div id="epotLocked">
          <div class="section-title">EPOT â€” Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</div>
          <p class="small">Ù…Ù‚ÙÙˆÙ„ â€” Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ø¶ØºØ· ÙØªØ­ EPOT ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
          <button class="btn btn-primary" id="openEpotBtn">ÙØªØ­ EPOT</button>
        </div>
        <div id="epotUnlocked" style="display: none;">
          <div class="section-title">EPOT</div>
          <button class="btn btn-secondary" id="lockEpotBtn" style="margin-bottom: 16px;">Ù‚ÙÙ„ EPOT</button>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
              <div class="stat-value" id="totalRevenue">0 Ø¬</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="stat-value" id="todayOrders">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="stat-value" id="todayRevenue">0 Ø¬</div>
            </div>
          </div>
          <button class="btn btn-danger" id="endDayBtn" style="width: 100%; margin-bottom: 20px;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</button>
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gold);">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT</h3>
            <div style="display: flex; gap: 8px;">
              <input id="newEpotPwd" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" />
              <button class="btn btn-primary" id="setEpotPwdBtn">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div style="margin-bottom: 20px;">
            <h3 style="color: var(--gold);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
              <input id="newItemName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" style="flex: 1; min-width: 150px;" />
              <input id="newItemPrice" class="input" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="width: 100px;" />
              <select id="newItemCategory" class="input" style="width: 150px;"></select>
              <button class="btn btn-primary" id="addItemBtn">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
            </div>
            <div id="manageItemsList"></div>
          </div>
          <div>
            <h3 style="color: var(--gold);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
              <input id="offerName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" style="flex: 1; min-width: 150px;" />
              <input id="offerDiscount" class="input" type="number" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %" style="width: 100px;" />
              <button class="btn btn-primary" id="createOfferBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶</button>
            </div>
            <div id="offersList"></div>
          </div>
          <button class="btn btn-secondary" id="exportDataBtn" style="width: 100%; margin-top: 20px;">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EPOT Password Modal -->
  <div class="modal" id="epotModal">
    <div class="modal-content">
      <div class="modal-title">ÙØªØ­ EPOT</div>
      <input id="epotPassword" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT" />
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn btn-primary" id="submitEpotBtn" style="flex: 1;">ÙØªØ­</button>
        <button class="btn btn-secondary" id="cancelEpotBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDdK_slp4ysFLYHknvwgpmqfcWQszB1rxs",
      authDomain: "koshary-abosamra.firebaseapp.com",
      databaseURL: "https://koshary-abosamra-default-rtdb.firebaseio.com",
      projectId: "koshary-abosamra",
      storageBucket: "koshary-abosamra.firebasestorage.app",
      messagingSenderId: "803911056967",
      appId: "1:803911056967:web:da1d8533ffe6c0fbc53b62",
      measurementId: "G-2TVX0F48Y8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Storage Keys
    const LS_KEYS = {
      MENU: 'tk_menu_v1',
      ORDERS: 'tk_orders_v1',
      HISTORY: 'tk_history_v1',
      OFFERS: 'tk_offers_v1',
      OP_PWD: 'tk_op_pwd_v1',
      EPOT_PWD: 'tk_epot_pwd_v1',
      CUST: 'tk_cust_v1',
      RECEIPT_COUNTER: 'tk_receipt_v1'
    };

    // Default Menu
    const DEFAULT_MENU = {
      "Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'k-mini', name: 'Ø¹Ù„Ø¨Ø© Ù…ÙŠÙ†ÙŠ', price: 17, available: true, sold: 0 },
        { id: 'k-large', name: 'Ø¹Ù„Ø¨Ø© Ù„Ø§Ø±Ø¬', price: 20, available: true, sold: 0 },
        { id: 'k-shaqia', name: 'Ø¹Ù„Ø¨Ø© Ø´Ù‚ÙŠØ©', price: 25, available: true, sold: 0 },
        { id: 'k-mftria', name: 'Ø¹Ù„Ø¨Ù‡ Ù…ÙØªØ±ÙŠØ©', price: 30, available: true, sold: 0 },
        { id: 'k-abo', name: 'Ø¹Ù„Ø¨Ø© Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©', price: 35, available: true, sold: 0 },
        { id: 'k-triple', name: 'Ø¹Ù„Ø¨Ø© ØªØ±ÙŠØ¨Ù„', price: 40, available: true, sold: 0 }
      ],
      "Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'add-tqliya', name: 'ØªÙ‚Ù„ÙŠÙ‡', price: 9, available: true, sold: 0 },
        { id: 'add-salsa', name: 'ØµÙ„ØµØ©', price: 6, available: true, sold: 0 },
        { id: 'add-dokka', name: 'Ø¯Ù‚Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-shata', name: 'Ø´Ø·Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-ads', name: 'Ø¹Ø¯Ø³', price: 6, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©": [
        { id: 'side-qaramisho', name: 'Ù‚Ø±Ø§Ù…ÙŠØ´Ùˆ (ØªÙˆØ³Øª)', price: 9, available: true, sold: 0 },
        { id: 'side-mkhlal', name: 'Ù…Ø®Ù„Ù„ Ù…Ø´ÙƒÙ„', price: 8, available: true, sold: 0 },
        { id: 'side-slt-kh', name: 'Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡', price: 8, available: true, sold: 0 },
        { id: 'side-khyar', name: 'Ø®ÙŠØ§Ø± Ù…ØªØ¨Ù„', price: 8, available: true, sold: 0 },
        { id: 'side-tmatem', name: 'Ø·Ù…Ø§Ø·Ù… Ù…ØªØ¨Ù„Ù‡', price: 8, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø·ÙˆØ§Ø¬Ù†": [
        { id: 't-mkr', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø©', price: 27, available: true, sold: 0 },
        { id: 't-mkr-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 45, available: true, sold: 0 },
        { id: 't-mkr-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 47, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙŠÙƒØ³": [
        { id: 'mix-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø³Ø§Ø¯Ø©', price: 47, available: true, sold: 0 },
        { id: 'mix-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 65, available: true, sold: 0 },
        { id: 'mix-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 65, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§": [
        { id: 'moz-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 47, available: true, sold: 0 },
        { id: 'moz-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ù„Ø­Ù…Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 },
        { id: 'moz-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ù„Ø¯Ø¬Ø§Ø¬ Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 }
      ],
      "Ø­Ù„Ùˆ Ø£Ø¨ÙˆØ³Ù…Ø±Ø©": [
        { id: 'hlb-kebir', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙƒØ¨ÙŠØ±', price: 18, available: true, sold: 0 },
        { id: 'hlb-forn', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙØ±Ù†', price: 20, available: true, sold: 0 },
        { id: 'hlb-koshry', name: 'ÙƒØ´Ø±ÙŠ Ø§Ù„Ø­Ù„Ùˆ', price: 22, available: true, sold: 0 },
        { id: 'hlb-qar3', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¹', price: 25, available: true, sold: 0 }
      ],
      "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [
        { id: 'water-s', name: 'Ù…ÙŠØ§Ù‡ ØµØºÙŠØ±Ø©', price: 6, available: true, sold: 0 },
        { id: 'water-l', name: 'Ù…ÙŠØ§Ù‡ ÙƒØ¨ÙŠØ±Ø©', price: 10, available: true, sold: 0 },
        { id: 'pepsi', name: 'Ø¨Ø¨ÙŠØ¬ ÙƒÙˆÙ„Ø§', price: 18, available: true, sold: 0 },
        { id: 'slsh-tot', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ ØªÙˆØª', price: 10, available: true, sold: 0 },
        { id: 'slsh-lmna', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ (Ù„ÙŠÙ…ÙˆÙ† â€“ Ù†Ø¹Ù†Ø§Ø¹)', price: 18, available: true, sold: 0 }
      ]
    };

    // State
    let menu = loadLS(LS_KEYS.MENU, DEFAULT_MENU);
    let orders = loadLS(LS_KEYS.ORDERS, []);
    let orderHistory = loadLS(LS_KEYS.HISTORY, []);
    let offers = loadLS(LS_KEYS.OFFERS, []);
    let cart = [];
    let currentCustomer = loadLS(LS_KEYS.CUST, null);
    let receiptCounter = Number(localStorage.getItem(LS_KEYS.RECEIPT_COUNTER) || 1);
    let operatorPassword = localStorage.getItem(LS_KEYS.OP_PWD) || 'admin123';
    let epotPassword = localStorage.getItem(LS_KEYS.EPOT_PWD) || 'epot123';
    let isOperatorAuth = false;
    let isEpotAuth = false;
    let currentView = 'customer';

    // Helpers
    function saveLS(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function loadLS(key, fallback) { 
      try { 
        const r = localStorage.getItem(key); 
        return r ? JSON.parse(r) : fallback; 
      } catch (e) { 
        return fallback; 
      } 
    }
    function generateId(prefix = 'ID') { 
      return prefix + '-' + Date.now().toString(36) + '-' + Math.floor(Math.random() * 900).toString(36); 
    }
    function saveState() {
      saveLS(LS_KEYS.MENU, menu);
      saveLS(LS_KEYS.ORDERS, orders);
      saveLS(LS_KEYS.HISTORY, orderHistory);
      saveLS(LS_KEYS.OFFERS, offers);
      saveLS(LS_KEYS.CUST, currentCustomer);
      localStorage.setItem(LS_KEYS.RECEIPT_COUNTER, String(receiptCounter));
    }
    function notify(msg, type = 'info') {
      const notif = document.getElementById('notification');
      notif.textContent = msg;
      notif.className = 'notification';
      if (type === 'error') notif.classList.add('error');
      if (type === 'warning') notif.classList.add('warning');
      notif.style.display = 'block';
      setTimeout(() => notif.style.display = 'none', 3000);
    }
    function findItemById(id) {
      for (const cat in menu) {
        const item = menu[cat].find(i => i.id === id);
        if (item) return item;
      }
      return null;
    }

    // Initialize
    window.onload = function() {
      syncFromFirebase();
      renderCategories();
      renderMenu();
      renderOffers();
      updateCartDisplay();
      checkCustomerOrders();
      setupEventListeners();
    };

    // Firebase Sync
    function syncFromFirebase() {
      database.ref('menu').on('value', (snapshot) => {
        if (snapshot.val()) {
          menu = snapshot.val();
          saveLS(LS_KEYS.MENU, menu);
          renderMenu();
          renderCategories();
        }
      });
      database.ref('offers').on('value', (snapshot) => {
        if (snapshot.val()) {
          offers = Object.values(snapshot.val());
          saveLS(LS_KEYS.OFFERS, offers);
          renderOffers();
        }
      });
      database.ref('orders').on('value', (snapshot) => {
        if (snapshot.val()) {
          orders = Object.values(snapshot.val());
          saveLS(LS_KEYS.ORDERS, orders);
          renderOrders();
          checkCustomerOrders();
        }
      });
      database.ref('history').on('value', (snapshot) => {
        if (snapshot.val()) {
          orderHistory = Object.values(snapshot.val());
          saveLS(LS_KEYS.HISTORY, orderHistory);
          renderHistory();
        }
      });
    }

    // Categories
    function renderCategories() {
      const container = document.getElementById('categoriesScroll');
      container.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = cat;
        btn.onclick = () => scrollToCategory(cat);
        container.appendChild(btn);
      });
    }

    function scrollToCategory(cat) {
      const section = document.getElementById(`section-${cat}`);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
      }
    }

    // Menu
    function renderMenu() {
      const container = document.getElementById('menuContainer');
      container.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const section = document.createElement('div');
        section.className = 'menu-section';
        section.id = `section-${cat}`;
        section.innerHTML = `<div class="section-title">${cat}</div><div class="menu-grid" id="grid-${cat}"></div>`;
        container.appendChild(section);
        const grid = section.querySelector('.menu-grid');
        menu[cat].forEach(item => {
          const card = document.createElement('div');
          card.className = 'menu-item';
          card.innerHTML = `
            <h4>${item.name}</h4>
            <div class="price">${item.price} Ø¬</div>
            ${!item.available ? '<div class="small" style="color: #f97316;">ØºÙŠØ± Ù…ØªÙˆÙØ±</div>' : ''}
            <button class="add-cart-btn" ${!item.available ? 'disabled' : ''}>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
          `;
          card.querySelector('button').onclick = () => addToCart(item.id);
          grid.appendChild(card);
        });
      });
    }

    // Cart
    function addToCart(itemId) {
      const item = findItemById(itemId);
      if (!item || !item.available) {
        notify('Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
        return;
      }
      const existing = cart.find(c => c.id === item.id);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ id: item.id, name: item.name, price: item.price, qty: 1 });
      }
      updateCartDisplay();
      notify(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${item.name}`, 'info');
      document.getElementById('cartPanel').classList.add('open');
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const cartBadge = document.getElementById('cartBadge');
      const cartTotal = document.getElementById('cartTotal');
      
      if (cart.length === 0) {
        cartItems.innerHTML = '<div class="small" style="text-align: center; padding: 20px; color: var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
        cartBadge.style.display = 'none';
        cartTotal.textContent = '0 Ø¬';
        return;
      }

      cartBadge.style.display = 'flex';
      cartBadge.textContent = cart.reduce((sum, c) => sum + c.qty, 0);

      cartItems.innerHTML = '';
      let total = 0;
      cart.forEach((item, idx) => {
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div>
            <strong>${item.name}</strong>
            <div class="small">${item.qty} Ã— ${item.price} Ø¬</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-end;">
            <div style="font-weight: bold; color: var(--gold);">${itemTotal} Ø¬</div>
            <div style="display: flex; gap: 6px;">
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.9rem;" onclick="decreaseQty(${idx})">-</button>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.9rem;" onclick="increaseQty(${idx})">+</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.9rem;" onclick="removeFromCart(${idx})">Ã—</button>
            </div>
          </div>
        `;
        cartItems.appendChild(div);
      });

      const offerId = document.getElementById('applyOffer').value;
      if (offerId) {
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
          total = Math.round(total * (1 - offer.discount / 100));
        }
      }

      cartTotal.textContent = `${total} Ø¬`;
    }

    window.increaseQty = function(idx) {
      cart[idx].qty++;
      updateCartDisplay();
    };

    window.decreaseQty = function(idx) {
      if (cart[idx].qty > 1) {
        cart[idx].qty--;
      } else {
        cart.splice(idx, 1);
      }
      updateCartDisplay();
    };

    window.removeFromCart = function(idx) {
      cart.splice(idx, 1);
      updateCartDisplay();
    };

    // Checkout
    function openCheckout() {
      if (cart.length === 0) {
        notify('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'warning');
        return;
      }
      document.getElementById('cartPanel').classList.remove('open');
      const section = document.getElementById('checkoutSection');
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth' });
      
      if (currentCustomer) {
        document.getElementById('orderName').value = currentCustomer.name || '';
        document.getElementById('orderPhone').value = currentCustomer.phone || '';
      }
    }

    function confirmOrder() {
      const name = document.getElementById('orderName').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const address = document.getElementById('orderAddress').value.trim();
      const payment = document.getElementById('orderPayment').value;
      const notes = document.getElementById('orderNotes').value.trim();

      if (!name || !phone || !address) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        return;
      }

      currentCustomer = { name, phone };
      saveLS(LS_KEYS.CUST, currentCustomer);

      const receiptNo = receiptCounter++;
      localStorage.setItem(LS_KEYS.RECEIPT_COUNTER, String(receiptCounter));

      const orderId = generateId('ORD');
      let total = cart.reduce((s, c) => s + c.price * c.qty, 0);
      const totalBefore = total;
      let appliedOffer = null;

      const offerId = document.getElementById('applyOffer').value;
      if (offerId) {
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
          appliedOffer = { id: offer.id, name: offer.name, discount: offer.discount };
          total = Math.round(total * (1 - offer.discount / 100));
        }
      }

      const newOrder = {
        id: orderId,
        receiptNo,
        customer: { name, phone, address },
        items: cart.map(c => ({ id: c.id, name: c.name, price: c.price, qty: c.qty })),
        totalBefore,
        total,
        payment,
        notes,
        appliedOffer,
        status: 'received',
        createdAt: new Date().toLocaleString('ar-EG'),
        date: new Date().toDateString(),
        customerPhone: phone
      };

      cart.forEach(c => {
        const item = findItemById(c.id);
        if (item) item.sold = (item.sold || 0) + c.qty;
      });

      database.ref('orders/' + orderId).set(newOrder);
      database.ref('menu').set(menu);

      orders.unshift(newOrder);
      saveState();

      cart = [];
      updateCartDisplay();
      document.getElementById('checkoutSection').style.display = 'none';
      notify(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… ${receiptNo}`, 'info');
      
      // Clear form
      document.getElementById('orderAddress').value = '';
      document.getElementById('orderNotes').value = '';
      
      checkCustomerOrders();
    }

    // Customer Order Status
    function checkCustomerOrders() {
      if (!currentCustomer || !currentCustomer.phone) return;
      
      const customerOrders = orders.filter(o => 
        o.customerPhone === currentCustomer.phone && 
        o.status !== 'delivered'
      );

      const statusDiv = document.getElementById('customerStatus');
      const statusContent = document.getElementById('statusContent');

      if (customerOrders.length > 0) {
        statusDiv.classList.add('show');
        statusContent.innerHTML = '';
        customerOrders.forEach(order => {
          const statusText = {
            'received': 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',
            'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
            'ready': 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'
          };
          const statusClass = {
            'received': 'badge-received',
            'preparing': 'badge-preparing',
            'ready': 'badge-ready'
          };
          const div = document.createElement('div');
          div.style.marginBottom = '12px';
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong>Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${order.receiptNo}</strong>
              <span class="badge ${statusClass[order.status]}">${statusText[order.status]}</span>
            </div>
            <div class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total} Ø¬</div>
          `;
          statusContent.appendChild(div);
        });
      } else {
        statusDiv.classList.remove('show');
      }
    }

    // Offers
    function renderOffers() {
      const select = document.getElementById('applyOffer');
      select.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
      offers.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = `${o.name} â€” ${o.discount}%`;
        select.appendChild(opt);
      });

      if (isEpotAuth) {
        const list = document.getElementById('offersList');
        if (list) {
          list.innerHTML = '';
          offers.forEach(o => {
            const div = document.createElement('div');
            div.className = 'stat-card';
            div.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${o.name}</strong>
                  <div class="small">Ø®ØµÙ… ${o.discount}%</div>
                </div>
                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="removeOffer('${o.id}')">Ø­Ø°Ù</button>
              </div>
            `;
            list.appendChild(div);
          });
        }
      }
    }

    function createOffer() {
      const name = document.getElementById('offerName').value.trim();
      const discount = Number(document.getElementById('offerDiscount').value);

      if (!name || isNaN(discount) || discount < 0 || discount > 100) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }

      const id = generateId('offer');
      const newOffer = { id, name, discount };
      offers.push(newOffer);

      database.ref('offers/' + id).set(newOffer);
      saveState();

      document.getElementById('offerName').value = '';
      document.getElementById('offerDiscount').value = '';

      renderOffers();
      notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶', 'info');
    }

    window.removeOffer = function(id) {
      offers = offers.filter(o => o.id !== id);
      database.ref('offers/' + id).remove();
      saveState();
      renderOffers();
      notify('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶', 'info');
    };

    // Orders Management
    function renderOrders() {
      const grid = document.getElementById('ordersGrid');
      if (!grid) return;

      grid.innerHTML = '';
      if (orders.length === 0) {
        grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
        return;
      }

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        const statusText = {
          'received': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
          'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
          'ready': 'Ø¬Ø§Ù‡Ø²',
          'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
        };
        const statusClass = {
          'received': 'badge-received',
          'preparing': 'badge-preparing',
          'ready': 'badge-ready',
          'delivered': 'badge-delivered'
        };
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
              <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
              <div class="small">${order.createdAt}</div>
            </div>
            <span class="badge ${statusClass[order.status]}">${statusText[order.status]}</span>
          </div>
          <div class="order-details" id="details-${order.id}">
            <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
              <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
              <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
              ${order.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes}</div>` : ''}
              <div style="margin-top: 12px;">
                ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
              </div>
              <div style="margin-top: 8px; font-size: 1.2rem; font-weight: bold; color: var(--gold);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total} Ø¬</div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
              ${order.status === 'received' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'preparing')">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>` : ''}
              ${order.status === 'preparing' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'ready')">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>` : ''}
              ${order.status === 'ready' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'delivered')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : ''}
              <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
          </div>
        `;
        card.onclick = (e) => {
          if (e.target.tagName !== 'BUTTON') {
            const details = document.getElementById(`details-${order.id}`);
            details.classList.toggle('open');
          }
        };
        grid.appendChild(card);
      });

      updateStats();
    }

    window.changeStatus = function(orderId, newStatus) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      order.status = newStatus;
      database.ref('orders/' + orderId).update({ status: newStatus });
      saveState();
      renderOrders();
      notify(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨`, 'info');
    };

    window.cancelOrder = function(orderId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;

      orders = orders.filter(o => o.id !== orderId);
      database.ref('orders/' + orderId).remove();
      saveState();
      renderOrders();
      notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨', 'info');
    };

    // Order History
    function renderHistory() {
      const grid = document.getElementById('historyGrid');
      if (!grid) return;

      grid.innerHTML = '';
      if (orderHistory.length === 0) {
        grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
        return;
      }

      orderHistory.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
              <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
              <div class="small">${order.createdAt}</div>
            </div>
            <div style="font-weight: bold; color: var(--gold);">${order.total} Ø¬</div>
          </div>
          <div class="order-details" id="hist-${order.id}">
            <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
              <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
              <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
              <div style="margin-top: 12px;">
                ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
              </div>
            </div>
          </div>
        `;
        card.onclick = () => {
          const details = document.getElementById(`hist-${order.id}`);
          details.classList.toggle('open');
        };
        grid.appendChild(card);
      });
    }

       function searchHistory() {
      const address = document.getElementById('searchAddress').value.trim().toLowerCase();
      const phone = document.getElementById('searchPhone').value.trim();
      const orderId = document.getElementById('searchOrderId').value.trim();
      const name = document.getElementById('searchName').value.trim().toLowerCase();

      const filtered = orderHistory.filter(o => {
        if (address && !o.customer.address.toLowerCase().includes(address)) return false;
        if (phone && !o.customer.phone.includes(phone)) return false;
        if (orderId && !String(o.receiptNo).includes(orderId)) return false;
        if (name && !o.customer.name.toLowerCase().includes(name)) return false;
        return true;
      });

      const grid = document.getElementById('historyGrid');
      grid.innerHTML = '';
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        return;
      }

      filtered.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
              <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
              <div class="small">${order.createdAt}</div>
            </div>
            <div style="font-weight: bold; color: var(--gold);">${order.total} Ø¬</div>
          </div>
          <div class="order-details" id="hist-${order.id}">
            <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
              <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
              <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
              <div style="margin-top: 12px;">
                ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
              </div>
            </div>
          </div>
        `;
        card.onclick = () => {
          const details = document.getElementById(`hist-${order.id}`);
          details.classList.toggle('open');
        };
        grid.appendChild(card);
      });
    }

    // End Day Function
    function endDay() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.')) return;

      orders.forEach(order => {
        if (!orderHistory.find(h => h.id === order.id)) {
          orderHistory.unshift(order);
        }
      });

      orders.forEach(order => {
        database.ref('orders/' + order.id).remove();
        database.ref('history/' + order.id).set(order);
      });

      orders = [];
      saveState();
      renderOrders();
      renderHistory();
      notify('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­', 'info');
    }

    // Stats
    function updateStats() {
      if (!isEpotAuth) return;

      const totalRev = document.getElementById('totalRevenue');
      const todayOrd = document.getElementById('todayOrders');
      const todayRev = document.getElementById('todayRevenue');

      if (totalRev && todayOrd && todayRev) {
        const allRevenue = orderHistory.reduce((sum, o) => sum + o.total, 0);
        totalRev.textContent = `${allRevenue} Ø¬`;

        const today = new Date().toDateString();
        const todayOrders = orders.filter(o => o.date === today);
        todayOrd.textContent = todayOrders.length;
        todayRev.textContent = `${todayOrders.reduce((s, o) => s + o.total, 0)} Ø¬`;
      }
    }

    // Item Management
    function renderItemManagement() {
      const list = document.getElementById('manageItemsList');
      if (!list) return;

      const catSelect = document.getElementById('newItemCategory');
      catSelect.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
      });

      list.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const section = document.createElement('div');
        section.style.marginBottom = '20px';
        section.innerHTML = `<h4 style="color: var(--gold); margin-bottom: 12px;">${cat}</h4>`;
        
        menu[cat].forEach(item => {
          const div = document.createElement('div');
          div.className = 'stat-card';
          div.style.marginBottom = '8px';
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${item.name}</strong>
                <div class="small">${item.price} Ø¬ â€” Ù…Ø¨ÙŠØ¹Ø§Øª: ${item.sold || 0}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn ${item.available ? 'btn-secondary' : 'btn-primary'}" style="padding: 6px 12px;" onclick="toggleAvailability('${item.id}')">
                  ${item.available ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±'}
                </button>
                <button class="btn btn-danger" style="padding: 6px 12px;" onclick="deleteItem('${item.id}')">Ø­Ø°Ù</button>
              </div>
            </div>
          `;
          section.appendChild(div);
        });
        
        list.appendChild(section);
      });
    }

    function addNewItem() {
      const name = document.getElementById('newItemName').value.trim();
      const price = Number(document.getElementById('newItemPrice').value);
      const category = document.getElementById('newItemCategory').value;

      if (!name || isNaN(price) || price < 0 || !category) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }

      const id = generateId('item');
      const newItem = { id, name, price, available: true, sold: 0 };

      if (!menu[category]) menu[category] = [];
      menu[category].push(newItem);

      database.ref('menu').set(menu);
      saveState();

      document.getElementById('newItemName').value = '';
      document.getElementById('newItemPrice').value = '';

      renderMenu();
      renderCategories();
      renderItemManagement();
      notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù', 'info');
    }

    window.toggleAvailability = function(itemId) {
      const item = findItemById(itemId);
      if (!item) return;

      item.available = !item.available;
      database.ref('menu').set(menu);
      saveState();

      renderMenu();
      renderItemManagement();
      notify(`ØªÙ… ${item.available ? 'Ø¥Ø¸Ù‡Ø§Ø±' : 'Ø¥Ø®ÙØ§Ø¡'} Ø§Ù„ØµÙ†Ù`, 'info');
    };

    window.deleteItem = function(itemId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) return;

      for (const cat in menu) {
        menu[cat] = menu[cat].filter(i => i.id !== itemId);
      }

      database.ref('menu').set(menu);
      saveState();

      renderMenu();
      renderCategories();
      renderItemManagement();
      notify('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù', 'info');
    };

    // Export Data
    function exportData() {
      const data = {
        menu,
        orders,
        orderHistory,
        offers,
        exportDate: new Date().toLocaleString('ar-EG')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `koshary-data-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      notify('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
    }

    // Event Listeners
    function setupEventListeners() {
      document.getElementById('cartToggle').onclick = () => {
        document.getElementById('cartPanel').classList.add('open');
      };

      document.getElementById('closeCart').onclick = () => {
        document.getElementById('cartPanel').classList.remove('open');
      };

      document.getElementById('clearCartBtn').onclick = () => {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ')) {
          cart = [];
          updateCartDisplay();
        }
      };

      document.getElementById('checkoutBtn').onclick = openCheckout;

      document.getElementById('confirmOrderBtn').onclick = confirmOrder;

      document.getElementById('cancelCheckoutBtn').onclick = () => {
        document.getElementById('checkoutSection').style.display = 'none';
      };

      document.getElementById('applyOffer').onchange = updateCartDisplay;

      document.getElementById('profileBtn').onclick = () => {
        document.getElementById('profileModal').classList.add('open');
      };

      document.getElementById('closeProfileBtn').onclick = () => {
        document.getElementById('profileModal').classList.remove('open');
      };

      document.getElementById('customerViewBtn').onclick = () => {
        document.getElementById('profileModal').classList.remove('open');
        showCustomerView();
      };

      document.getElementById('operatorLoginBtn').onclick = () => {
        document.getElementById('profileModal').classList.remove('open');
        document.getElementById('operatorModal').classList.add('open');
      };

      document.getElementById('cancelOperatorBtn').onclick = () => {
        document.getElementById('operatorModal').classList.remove('open');
      };

      document.getElementById('submitOperatorBtn').onclick = () => {
        const pwd = document.getElementById('operatorPassword').value;
        if (pwd === operatorPassword) {
          isOperatorAuth = true;
          document.getElementById('operatorModal').classList.remove('open');
          showOperatorView();
        } else {
          notify('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
        }
        document.getElementById('operatorPassword').value = '';
      };

      document.getElementById('logoutBtn').onclick = () => {
        isOperatorAuth = false;
        isEpotAuth = false;
        showCustomerView();
      };

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = (e) => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
          
          e.target.classList.add('active');
          const tabName = e.target.dataset.tab;
          document.getElementById(tabName + 'Content').classList.add('active');

          if (tabName === 'history') renderHistory();
          if (tabName === 'orders') renderOrders();
        };
      });

      document.getElementById('searchBtn').onclick = searchHistory;

      document.getElementById('openEpotBtn').onclick = () => {
        document.getElementById('epotModal').classList.add('open');
      };

      document.getElementById('cancelEpotBtn').onclick = () => {
        document.getElementById('epotModal').classList.remove('open');
      };

      document.getElementById('submitEpotBtn').onclick = () => {
        const pwd = document.getElementById('epotPassword').value;
        if (pwd === epotPassword) {
          isEpotAuth = true;
          document.getElementById('epotModal').classList.remove('open');
          showEpotPanel();
        } else {
          notify('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
        }
        document.getElementById('epotPassword').value = '';
      };

      document.getElementById('lockEpotBtn').onclick = () => {
        isEpotAuth = false;
        document.getElementById('epotUnlocked').style.display = 'none';
        document.getElementById('epotLocked').style.display = 'block';
      };

      document.getElementById('setEpotPwdBtn').onclick = () => {
        const newPwd = document.getElementById('newEpotPwd').value.trim();
        if (!newPwd) {
          notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±', 'warning');
          return;
        }
        epotPassword = newPwd;
        localStorage.setItem(LS_KEYS.EPOT_PWD, epotPassword);
        document.getElementById('newEpotPwd').value = '';
        notify('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'info');
      };

      document.getElementById('addItemBtn').onclick = addNewItem;

      document.getElementById('createOfferBtn').onclick = createOffer;

      document.getElementById('exportDataBtn').onclick = exportData;

      document.getElementById('endDayBtn').onclick = endDay;
    }

    function showCustomerView() {
      currentView = 'customer';
      document.getElementById('operatorDashboard').style.display = 'none';
      document.getElementById('menuContainer').style.display = 'block';
      document.querySelector('.header').style.display = 'flex';
      document.querySelector('.categories-section').style.display = 'block';
      document.getElementById('cartToggle').style.display = 'flex';
    }

    function showOperatorView() {
      currentView = 'operator';
      document.getElementById('menuContainer').style.display = 'none';
      document.querySelector('.header').style.display = 'none';
      document.querySelector('.categories-section').style.display = 'none';
      document.getElementById('cartToggle').style.display = 'none';
      document.getElementById('cartPanel').classList.remove('open');
      document.getElementById('checkoutSection').style.display = 'none';
      document.getElementById('customerStatus').classList.remove('show');
      
      document.getElementById('operatorDashboard').style.display = 'block';
      renderOrders();
      renderHistory();
    }

    function showEpotPanel() {
      document.getElementById('epotLocked').style.display = 'none';
      document.getElementById('epotUnlocked').style.display = 'block';
      updateStats();
      renderItemManagement();
      renderOffers();
    }
  </script>
</body>
</html>
