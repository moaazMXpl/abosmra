<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø© (Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„ - Ø§Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†)</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #ff6b35;
      --gold: #ffd700;
      --success: #16a34a;
    }
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: #e6eef8;
    }
    .container {
      max-width: 1200px;
      margin: 18px auto;
      padding: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .brand {
      display: flex;
      flex-direction: column;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.4px;
    }
    .brand p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn {
      background: var(--accent);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
    }
    .btn.secondary {
      background: #374151;
      color: #fff;
    }
    .card {
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(255, 215, 0, 0.06);
    }
    /* layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }
    @media (max-width: 980px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
    /* menu */
    .menu-section {
      margin-bottom: 12px;
    }
    .section-title {
      background: var(--gold);
      color: #1f2937;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      font-size: 1rem;
    }
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .menu-item {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 215, 0, 0.04);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .menu-item h4 {
      margin: 0;
      color: #e6eef8;
      font-size: 1rem;
    }
    .price {
      color: var(--accent);
      font-weight: bold;
    }
    .controls-small {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .qty-btn {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      border: 0;
      background: rgba(255, 255, 255, 0.03);
      color: #fff;
      cursor: pointer;
    }
    .add-cart {
      background: var(--success);
      color: #fff;
      padding: 8px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
    }
    /* cart panel - hidden by default */
    .cart-panel {
      position: fixed;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100vh;
      background: var(--card);
      padding: 12px;
      border-left: 1px solid rgba(255, 0, 0, 0.4);
      transition: right 0.3s;
      z-index: 999;
      overflow-y: auto;
      box-shadow: -6px 0 18px rgba(2, 6, 23, 0.6);
    }
    .cart-panel.open {
      right: 0;
    }
    .cart-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: 0;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cart-title {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .cart-items {
      max-height: calc(50vh - 100px);
      overflow: auto;
      margin-bottom: 10px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.01);
      margin-bottom: 8px;
    }
    /* bottom cart when scrolled to bottom */
    .bottom-cart {
      display: none;
      background: var(--card);
      padding: 12px;
      border-top: 1px solid rgba(255, 215, 0, 0.04);
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      .cart-panel {
        width: 100%;
        right: -100%;
      }
      .cart-panel.open {
        right: 0;
      }
    }
    /* operator */
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
    }
    .tab.active {
      background: var(--accent);
      color: #fff;
    }
    .tabContent {
      display: none;
    }
    .tabContent:first-of-type {
      display: block;
    }
    .orders-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .order-card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 215, 0, 0.04);
      cursor: pointer;
    }
    .order-details {
      display: none;
      margin-top: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
    }
    .order-details.open {
      display: block;
    }
    /* small helpers */
    .input,
    textarea,
    select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: transparent;
      color: inherit;
    }
    .small {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .kv {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--gold);
      color: #1f2937;
      font-weight: bold;
      font-size: 0.85rem;
    }
    .notify {
      position: fixed;
      left: 18px;
      bottom: 18px;
      padding: 10px;
      border-radius: 10px;
      background: var(--success);
      color: #fff;
      display: none;
      z-index: 9999;
    }
    .footer {
      font-size: 0.85rem;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
    }
    /* offer badges */
    .offer-badge {
      background: #064e3b;
      color: #fff;
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.85rem;
    }
    /* fixed operator button */
    #operatorQuickBtn {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #374151;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      z-index: 99999;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.04);
    }
    /* password modal */
    #pwdModal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 99998;
    }
    #pwdModal .modalCard {
      width: 320px;
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    #pwdModal .modalCard h3 {
      margin: 0 0 8px 0;
    }
    #pwdModal .modalActions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    /* epot modal */
    #epotModal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 99999;
    }
    #epotModal .modalCard {
      width: 360px;
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    /* small inline buttons used inside cards */
    .btn.small-inline {
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    /* responsive for small screens button position */
    @media (max-width: 420px) {
      #operatorQuickBtn {
        right: 10px;
        top: 10px;
        width: 40px;
        height: 40px;
        font-size: 22px;
      }
      .cart-toggle {
        bottom: 80px;
      }
    }
    /* quantity modal */
    #qtyModal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 99998;
    }
    #qtyModal .modalCard {
      width: 320px;
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }
    #qtyModal .modalActions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }
  </style>
  <!-- Ù…ÙƒØªØ¨Ø§Øª Firebase - ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ compat builds Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ v10 -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body id="body">
  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>ğŸ› ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©</h1>
        <p class="small">Ù†Ø¸Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠ (Ø¹Ù…ÙŠÙ„ + Ù…Ø´ØºÙ„) â€” ÙƒÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</p>
      </div>
      <div class="controls">
        <!-- kept empty for future top controls -->
      </div>
    </div>
    <div id="mainCustomer" class="card">
      <div class="grid-2">
        <div>
          <div id="menuContainer"></div>
        </div>
      </div>
      <aside class="cart-panel" id="cartPanel">
        <div class="cart-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        <div class="small" id="cartCustomerInfo">Ø¶ÙŠÙ â€” Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯</div>
        <div class="cart-items" id="cartItems"></div>
        <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 8px">
          <div class="badge" id="cartTotal">0 Ø¬</div>
          <div class="small" style="flex: 1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
        <div style="margin-bottom: 8px">
          <label class="small">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="applyOffer" class="input"></select>
        </div>
        <div style="display: flex; gap: 8px">
          <button class="add-cart" id="checkoutBtn" style="flex: 1">Ø§ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn secondary" id="clearCartBtn" style="padding-inline: 10px">ØªÙØ±ÙŠØº</button>
        </div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: var(--muted)">
          Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ â€” ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø©/ÙÙˆØ±ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
        </div>
      </aside>
      <button class="cart-toggle" id="cartToggle">ğŸ›’</button>
      <div class="bottom-cart" id="bottomCart"></div>
      <div id="checkoutSection" class="card" style="margin-top: 12px; display: none">
        <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ & Ø§Ù„Ø¯ÙØ¹</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
          <input id="orderName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />
          <input id="orderPhone" class="input" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
          <input id="orderAddress" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ØªÙØµÙŠÙ„)" style="grid-column: 1/3" />
          <select id="orderPayment" class="input">
            <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
            <option value="vodafone">ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
            <option value="card">Ø¨Ø·Ø§Ù‚Ø© (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
            <option value="fawry">ÙÙˆØ±ÙŠ (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
          </select>
          <textarea id="orderNotes" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="grid-column: 1/3"></textarea>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 10px">
          <button class="add-cart" id="confirmOrderBtn" style="flex: 1">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn secondary" id="cancelCheckoutBtn">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
    <div id="mainOperator" class="card" style="display: none">
      <div id="operatorLoginPanel">
        <div style="display: flex; gap: 8px; align-items: center">
          <div style="flex: 1">
            <div class="small">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„</div>
            <input id="operatorPasswordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px">
            <button class="btn" id="operatorLoginBtn">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn secondary" id="showPwdBtn">Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
          </div>
        </div>
      </div>
      <div id="operatorDashboard" style="display: none; margin-top: 12px">
        <div style="display: flex; justify-content: space-between; align-items: center">
          <div style="display: flex; align-items: center; gap: 12px">
            <div class="kv">
              <div class="badge">Operator</div>
              <div class="small" style="margin-inline-start: 8px" id="operatorHint">Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px">
            <button class="btn secondary" id="operatorLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
        <div style="margin-top: 12px" class="card">
          <div class="tabs" id="opTabs">
            <div class="tab active" data-tab="ordersTab">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="tab" data-tab="epotTab">EPOT</div>
          </div>
          <div id="ordersTab" class="tabContent">
            <div class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="orders-grid" id="ordersGrid"></div>
          </div>
          <div id="epotTab" class="tabContent" style="display: none">
            <div class="section-title">EPOT â€” Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</div>
            <div id="epotLockedNotice" class="small">Ù…Ù‚ÙÙˆÙ„ â€” Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ø¶ØºØ· ÙØªØ­ EPOT ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</div>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <button class="btn" id="openEpotBtn">ÙØªØ­ EPOT</button>
              <button class="btn secondary" id="lockEpotBtn" style="display: none">Ù‚ÙÙ„ EPOT</button>
            </div>
            <div id="epotContent" style="display: none; margin-top: 10px">
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px">
                <div class="card small">
                  <div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¬)</div>
                  <div id="epotTotal" style="font-weight: bold; font-size: 1.4rem">0</div>
                </div>
                <div style="flex: 1">
                  <div class="small">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT</div>
                  <div style="display: flex; gap: 8px; margin-top: 6px">
                    <input id="newEpotPwd" class="input" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" />
                    <button class="btn" id="setEpotPwdBtn">ØªØ­Ø¯ÙŠØ«</button>
                  </div>
                </div>
              </div>
              <div style="margin-top: 12px">
                <h4 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
                <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center">
                  <input id="newItemName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" style="flex: 1" />
                  <input id="newItemPrice" class="input" placeholder="Ø§Ù„Ø³Ø¹Ø±" type="number" min="0" style="width: 120px" />
                  <select id="newItemCategory" class="input" style="width: 150px"></select>
                  <button class="btn" id="addItemBtn">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                  <button class="btn secondary" id="exportDataBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
                <div id="manageItemsList"></div>
              </div>
              <div style="margin-top: 12px">
                <h4 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h4>
                <div style="display: flex; gap: 12px; flex-wrap: wrap">
                  <div style="flex: 1; min-width: 320px">
                    <div id="activeOffersList"></div>
                  </div>
                  <div style="width: 320px">
                    <h4 class="small">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h4>
                    <input id="offerName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" />
                    <input id="offerDiscount" class="input" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)" type="number" min="0" max="100" />
                    <button class="btn" id="createOfferBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶</button>
                    <div class="small" id="offerNotice" style="color: var(--muted)">Ø¥Ù†Ø´Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ© EPOT.</div>
                  </div>
                </div>
              </div>
              <div style="margin-top: 12px">
                <h4 class="section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
                <div
                  style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px"
                >
                  <div class="card small">
                    <div class="small">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    <div id="rToday" style="font-weight: bold; font-size: 1.4rem">0</div>
                  </div>
                  <div class="card small">
                    <div class="small">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ… (Ø¬)</div>
                    <div id="rRevenue" style="font-weight: bold; font-size: 1.4rem">0</div>
                  </div>
                  <div class="card small">
                    <div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    <div id="rTotal" style="font-weight: bold; font-size: 1.4rem">0</div>
                  </div>
                  <div class="card small">
                    <div class="small">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§</div>
                    <div id="rTop" style="font-weight: bold; font-size: 1.4rem">-</div>
                  </div>
                </div>
                <div id="popularList"></div>
              </div>
              <div>
                <h4 class="small">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                <div id="epotOrdersList" style="margin-top: 8px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="notify" class="notify"></div>
    <div class="footer small">Ù‡Ø°Ø§ Ù…Ù„Ù Ù…Ø³ØªÙ‚Ù„. ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§.</div>
  </div>
  <div id="operatorQuickBtn" title="Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„">!</div>
  <div id="pwdModal">
    <div class="modalCard">
      <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„</h3>
      <div class="small" style="margin-bottom: 8px">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø´ØºÙ„</div>
      <input id="quickPwdInput" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <div class="modalActions">
        <button class="btn secondary" id="cancelPwdBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="submitPwdBtn">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>
  <div id="epotModal">
    <div class="modalCard">
      <h3>ÙØªØ­ EPOT</h3>
      <div class="small" style="margin-bottom: 8px">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT Ù„Ù„ÙˆØµÙˆÙ„ Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      <input id="epotPwdInput" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT" />
      <div class="modalActions">
        <button class="btn secondary" id="cancelEpotBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="unlockEpotBtn">ÙØªØ­</button>
      </div>
    </div>
  </div>
  <div id="qtyModal">
    <div class="modalCard">
      <h3>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©</h3>
      <input id="customQty" class="input" type="number" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©" />
      <div class="modalActions">
        <button class="btn secondary" id="cancelQtyBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn" id="addCustomQtyBtn">ÙˆØ¶Ø¹ ÙÙŠ Ø§Ù„Ø³Ù„Ø©</button>
      </div>
    </div>
  </div>
  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDdK_slp4ysFLYHknvwgpmqfcWQszB1rxs",
      authDomain: "koshary-abosamra.firebaseapp.com",
      databaseURL: "https://koshary-abosamra-default-rtdb.firebaseio.com",
      projectId: "koshary-abosamra",
      storageBucket: "koshary-abosamra.firebasestorage.app",
      messagingSenderId: "803911056967",
      appId: "1:803911056967:web:da1d8533ffe6c0fbc53b62",
      measurementId: "G-2TVX0F48Y8"
    };
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    // --- Configuration for real-time sync ---
    const SYNC_CONFIG = window.SYNC_CONFIG || {
      useWebSocket: false,
      wsUrl: ''
    };
    // --- Utilities and storage helpers ---
    const LS_KEYS = {
      MENU: 'tk_menu_v1',
      ORDERS: 'tk_orders_v1',
      OFFERS: 'tk_offers_v1',
      OP_PWD: 'tk_op_pwd_v1',
      CUST: 'tk_cust_v1',
      ORDER_COUNTER: 'tk_order_counter_v1',
      EPOT_PWD: 'tk_epot_pwd_v1'
    };
    function saveLS(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function loadLS(key, fallback) { try { const r = localStorage.getItem(key); return r ? JSON.parse(r) : fallback; } catch (e) { return fallback; } }
    function generateId(prefix = 'ID') { return prefix + '-' + Date.now().toString(36) + '-' + Math.floor(Math.random() * 900).toString(36); }
    // --- Default data ---
    const DEFAULT_MENU = {
      "Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'k-mini', name: 'Ø¹Ù„Ø¨Ø© Ù…ÙŠÙ†ÙŠ', price: 17, available: true, sold: 0 },
        { id: 'k-large', name: 'Ø¹Ù„Ø¨Ø© Ù„Ø§Ø±Ø¬', price: 20, available: true, sold: 0 },
        { id: 'k-shaqia', name: 'Ø¹Ù„Ø¨Ø© Ø´Ù‚ÙŠØ©', price: 25, available: true, sold: 0 },
        { id: 'k-mftria', name: 'Ø¹Ù„Ø¨Ù‡ Ù…ÙØªØ±ÙŠØ©', price: 30, available: true, sold: 0 },
        { id: 'k-abo', name: 'Ø¹Ù„Ø¨Ø© Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©', price: 35, available: true, sold: 0 },
        { id: 'k-triple', name: 'Ø¹Ù„Ø¨Ø© ØªØ±ÙŠØ¨Ù„', price: 40, available: true, sold: 0 }
      ],
      "Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'add-tqliya', name: 'ØªÙ‚Ù„ÙŠÙ‡', price: 9, available: true, sold: 0 },
        { id: 'add-salsa', name: 'ØµÙ„ØµØ©', price: 6, available: true, sold: 0 },
        { id: 'add-dokka', name: 'Ø¯Ù‚Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-shata', name: 'Ø´Ø·Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-ads', name: 'Ø¹Ø¯Ø³', price: 6, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©": [
        { id: 'side-qaramisho', name: 'Ù‚Ø±Ø§Ù…ÙŠØ´Ùˆ (ØªÙˆØ³Øª)', price: 9, available: true, sold: 0 },
        { id: 'side-mkhlal', name: 'Ù…Ø®Ù„Ù„ Ù…Ø´ÙƒÙ„', price: 8, available: true, sold: 0 },
        { id: 'side-slt-kh', name: 'Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡', price: 8, available: true, sold: 0 },
        { id: 'side-khyar', name: 'Ø®ÙŠØ§Ø± Ù…ØªØ¨Ù„', price: 8, available: true, sold: 0 },
        { id: 'side-tmatem', name: 'Ø·Ù…Ø§Ø·Ù… Ù…ØªØ¨Ù„Ù‡', price: 8, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø·ÙˆØ§Ø¬Ù†": [
        { id: 't-mkr', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø©', price: 27, available: true, sold: 0 },
        { id: 't-mkr-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 45, available: true, sold: 0 },
        { id: 't-mkr-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 47, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙŠÙƒØ³": [
        { id: 'mix-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø³Ø§Ø¯Ø©', price: 47, available: true, sold: 0 },
        { id: 'mix-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 65, available: true, sold: 0 },
        { id: 'mix-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 65, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§": [
        { id: 'moz-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 47, available: true, sold: 0 },
        { id: 'moz-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ù„Ø­Ù…Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 },
        { id: 'moz-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ù„Ø¯Ø¬Ø§Ø¬ Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 }
      ],
      "Ø­Ù„Ùˆ Ø£Ø¨ÙˆØ³Ù…Ø±Ø©": [
        { id: 'hlb-kebir', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙƒØ¨ÙŠØ±', price: 18, available: true, sold: 0 },
        { id: 'hlb-forn', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙØ±Ù†', price: 20, available: true, sold: 0 },
        { id: 'hlb-koshry', name: 'ÙƒØ´Ø±ÙŠ Ø§Ù„Ø­Ù„Ùˆ', price: 22, available: true, sold: 0 },
        { id: 'hlb-qar3', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¹', price: 25, available: true, sold: 0 }
      ],
      "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [
        { id: 'water-s', name: 'Ù…ÙŠØ§Ù‡ ØµØºÙŠØ±Ø©', price: 6, available: true, sold: 0 },
        { id: 'water-l', name: 'Ù…ÙŠØ§Ù‡ ÙƒØ¨ÙŠØ±Ø©', price: 10, available: true, sold: 0 },
        { id: 'pepsi', name: 'Ø¨Ø¨ÙŠØ¬ ÙƒÙˆÙ„Ø§', price: 18, available: true, sold: 0 },
        { id: 'slsh-tot', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ ØªÙˆØª', price: 10, available: true, sold: 0 },
        { id: 'slsh-lmna', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ (Ù„ÙŠÙ…ÙˆÙ† â€“ Ù†Ø¹Ù†Ø§Ø¹)', price: 18, available: true, sold: 0 }
      ]
    };
    // --- State ---
    let menu = loadLS(LS_KEYS.MENU, DEFAULT_MENU);
    let orders = loadLS(LS_KEYS.ORDERS, []);
    let offers = loadLS(LS_KEYS.OFFERS, []);
    let operatorPassword = localStorage.getItem(LS_KEYS.OP_PWD) || 'admin123';
    let currentCustomer = loadLS(LS_KEYS.CUST, null);
    let orderCounter = Number(localStorage.getItem(LS_KEYS.ORDER_COUNTER) || Date.now() % 100000);
    let epotPassword = localStorage.getItem(LS_KEYS.EPOT_PWD) || 'epot123';
    let epotAuthenticated = false;
    // --- DOM refs ---
    const menuContainer = document.getElementById('menuContainer');
    const cartItemsEl = document.getElementById('cartItems');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCustomerInfo = document.getElementById('cartCustomerInfo');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const checkoutSection = document.getElementById('checkoutSection');
    const confirmOrderBtn = document.getElementById('confirmOrderBtn');
    const cancelCheckoutBtn = document.getElementById('cancelCheckoutBtn');
    const orderName = document.getElementById('orderName');
    const orderPhone = document.getElementById('orderPhone');
    const orderAddress = document.getElementById('orderAddress');
    const orderPayment = document.getElementById('orderPayment');
    const orderNotes = document.getElementById('orderNotes');
    const applyOfferSelect = document.getElementById('applyOffer');
    const cartPanel = document.getElementById('cartPanel');
    const bottomCart = document.getElementById('bottomCart');
    const cartToggle = document.getElementById('cartToggle');
    const mainCustomer = document.getElementById('mainCustomer');
    const mainOperator = document.getElementById('mainOperator');
    const operatorLoginPanel = document.getElementById('operatorLoginPanel');
    const operatorDashboard = document.getElementById('operatorDashboard');
    const operatorHint = document.getElementById('operatorHint');
    const operatorQuickBtn = document.getElementById('operatorQuickBtn');
    const pwdModal = document.getElementById('pwdModal');
    const quickPwdInput = document.getElementById('quickPwdInput');
    const submitPwdBtn = document.getElementById('submitPwdBtn');
    const cancelPwdBtn = document.getElementById('cancelPwdBtn');
    const operatorLoginBtn = document.getElementById('operatorLoginBtn');
    const operatorPasswordInput = document.getElementById('operatorPasswordInput');
    const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const showPwdBtn = document.getElementById('showPwdBtn');
    const opTabs = document.getElementById('opTabs');
    const ordersGrid = document.getElementById('ordersGrid');
    const rToday = document.getElementById('rToday');
    const rRevenue = document.getElementById('rRevenue');
    const rTotal = document.getElementById('rTotal');
    const rTop = document.getElementById('rTop');
    const activeOffersList = document.getElementById('activeOffersList');
    const createOfferBtn = document.getElementById('createOfferBtn');
    const offerName = document.getElementById('offerName');
    const offerDiscount = document.getElementById('offerDiscount');
    const popularList = document.getElementById('popularList');
    const epotModal = document.getElementById('epotModal');
    const epotPwdInput = document.getElementById('epotPwdInput');
    const cancelEpotBtn = document.getElementById('cancelEpotBtn');
    const unlockEpotBtn = document.getElementById('unlockEpotBtn');
    const openEpotBtn = document.getElementById('openEpotBtn');
    const lockEpotBtn = document.getElementById('lockEpotBtn');
    const epotContent = document.getElementById('epotContent');
    const epotLockedNotice = document.getElementById('epotLockedNotice');
    const epotTotal = document.getElementById('epotTotal');
    const epotOrdersList = document.getElementById('epotOrdersList');
    const newEpotPwd = document.getElementById('newEpotPwd');
    const setEpotPwdBtn = document.getElementById('setEpotPwdBtn');
    const offerNotice = document.getElementById('offerNotice');
    // manage items refs
    const newItemName = document.getElementById('newItemName');
    const newItemPrice = document.getElementById('newItemPrice');
    const newItemCategory = document.getElementById('newItemCategory');
    const addItemBtn = document.getElementById('addItemBtn');
    const manageItemsList = document.getElementById('manageItemsList');
    // quantity modal refs
    const qtyModal = document.getElementById('qtyModal');
    const customQty = document.getElementById('customQty');
    const addCustomQtyBtn = document.getElementById('addCustomQtyBtn');
    const cancelQtyBtn = document.getElementById('cancelQtyBtn');
    // cart runtime
    let cart = [];
    let isOperatorAuthenticated = false;
    let currentItemForQty = null;
    let openOrderId = null;
    // --- Sync runtime ---
    let bc = null;
    let ws = null;
    // --- Init ---
    window.onload = function () {
      init();
    };
    function init() {
      // Safety checks for event listeners
      if (checkoutBtn) checkoutBtn.addEventListener('click', openCheckout);
      if (cancelCheckoutBtn)
        cancelCheckoutBtn.addEventListener('click', () => (checkoutSection.style.display = 'none'));
      if (confirmOrderBtn) confirmOrderBtn.addEventListener('click', confirmOrder);
      if (createOfferBtn) createOfferBtn.addEventListener('click', createOffer);
      if (exportDataBtn) exportDataBtn.addEventListener('click', exportAllData);
      if (operatorQuickBtn) operatorQuickBtn.addEventListener('click', onOperatorQuickClick);
      if (submitPwdBtn) submitPwdBtn.addEventListener('click', onSubmitQuickPwd);
      if (cancelPwdBtn)
        cancelPwdBtn.addEventListener('click', () => {
          pwdModal.style.display = 'none';
          quickPwdInput.value = '';
        });
      if (operatorLoginBtn) operatorLoginBtn.addEventListener('click', operatorLogin);
      if (operatorLogoutBtn) operatorLogoutBtn.addEventListener('click', operatorLogout);
      if (showPwdBtn)
        showPwdBtn.addEventListener('click', () => alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ' + operatorPassword));
      if (openEpotBtn)
        openEpotBtn.addEventListener('click', () => {
          epotModal.style.display = 'flex';
          epotPwdInput.value = '';
          epotPwdInput.focus();
        });
      if (cancelEpotBtn) cancelEpotBtn.addEventListener('click', () => (epotModal.style.display = 'none'));
      if (unlockEpotBtn) unlockEpotBtn.addEventListener('click', unlockEpot);
      if (lockEpotBtn) lockEpotBtn.addEventListener('click', lockEpot);
      if (setEpotPwdBtn) setEpotPwdBtn.addEventListener('click', setNewEpotPwd);
      if (opTabs)
        opTabs.addEventListener('click', (e) => {
          if (e.target && e.target.dataset.tab) {
            document.querySelectorAll('#opTabs .tab').forEach((t) => t.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.tabContent').forEach((tc) => (tc.style.display = 'none'));
            document.getElementById(e.target.dataset.tab).style.display = 'block';
            if (e.target.dataset.tab === 'epotTab') {
              if (epotAuthenticated) showEpotContent();
            }
            if (e.target.dataset.tab === 'ordersTab') {
              renderOrders();
            }
          }
        });
      if (addCustomQtyBtn) addCustomQtyBtn.addEventListener('click', addCustomQty);
      if (cancelQtyBtn)
        cancelQtyBtn.addEventListener('click', () => {
          qtyModal.style.display = 'none';
          currentItemForQty = null;
        });
      if (cartToggle)
        cartToggle.addEventListener('click', () => {
          cartPanel.classList.toggle('open');
        });
      if (document.getElementById('clearCartBtn'))
        document.getElementById('clearCartBtn').addEventListener('click', () => {
          cart = [];
          updateCartDisplay();
          notify('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©', 'info');
        });
      if (addItemBtn) addItemBtn.addEventListener('click', addNewItem);
      window.addEventListener('scroll', handleScrollForCart);
      syncMenuFromFirebase();
      syncOffersFromFirebase();
      syncOrdersFromFirebase();
      renderMenu();
      renderApplyOffers();
      renderOffers();
      populateCategories();
      saveState();
      renderOrders();
      updateReports();
      initSync();
      updateEditControls();
    }
    // --- Sync ---
    function initSync() {
      try {
        bc = new BroadcastChannel('talabat_sync');
        bc.addEventListener('message', (ev) => handleSyncMessage(ev.data, false));
      } catch (e) {
        bc = null;
      }
      if (SYNC_CONFIG.useWebSocket && SYNC_CONFIG.wsUrl) {
        try {
          ws = new WebSocket(SYNC_CONFIG.wsUrl);
          ws.addEventListener('open', () => {
            console.log('WS connected');
            ws.send(JSON.stringify({ type: 'hello', payload: { host: location.hostname } }));
          });
          ws.addEventListener('message', (ev) => {
            try {
              const data = JSON.parse(ev.data);
              handleSyncMessage(data, true);
            } catch (e) {
              console.warn('Bad WS message', e);
            }
          });
          ws.addEventListener('close', () => {
            console.log('WS closed, reconnect in 3s');
            setTimeout(initSync, 3000);
          });
          ws.addEventListener('error', (err) => {
            console.warn('WS error', err);
          });
        } catch (e) {
          console.warn('WS init failed', e);
          ws = null;
        }
      }
    }
    function broadcast(msg) {
      msg._from = location.hostname + ':' + Date.now();
      if (bc)
        try {
          bc.postMessage(msg);
        } catch (e) {}
      if (ws && ws.readyState === WebSocket.OPEN)
        try {
          ws.send(JSON.stringify(msg));
        } catch (e) {}
    }
    function handleSyncMessage(msg, fromServer) {
      if (!msg || !msg.type) return;
      try {
        if (msg.type === 'order_created') {
          const ord = msg.payload;
          if (!ord || !ord.id) return;
          if (!orders.find((o) => o.id === ord.id)) {
            orders.unshift(ord);
            saveState();
            renderOrders();
            updateReports();
            notify('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…: ' + ord.id, 'info');
            openOrderId = ord.id;
            toggleOrderDetails(ord.id);
          }
        } else if (msg.type === 'menu_update') {
          if (msg.payload) {
            menu = msg.payload;
            saveState();
            renderMenu();
            notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±', 'info');
          }
        } else if (msg.type === 'offer_update') {
          if (msg.payload) {
            offers = msg.payload;
            saveState();
            renderOffers();
            renderApplyOffers();
            notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±', 'info');
          }
        } else if (msg.type === 'order_status_update') {
          const p = msg.payload;
          if (p && p.id) {
            const ord = orders.find((o) => o.id === p.id);
            if (ord) {
              ord.status = p.status;
              saveState();
              renderOrders();
              updateReports();
              notify('ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„Ø´Ø¨ÙƒØ©: ' + p.id, 'info');
            }
          }
        }
      } catch (e) {
        console.error('handleSyncMessage error', e);
      }
    }
    // --- Firebase Sync Functions ---
    function syncMenuFromFirebase() {
      database.ref('menu').on('value', (snapshot) => {
        const data = snapshot.val();
        menu = data || DEFAULT_MENU;
        saveLS(LS_KEYS.MENU, menu);
        renderMenu();
        renderManageItems();
        populateCategories();
        notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'info');
      }, (error) => {
        console.error("Firebase error: ", error);
        menu = DEFAULT_MENU;
        renderMenu();
        notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'warning');
      });
    }
    function syncOffersFromFirebase() {
      database.ref('offers').on('value', (snapshot) => {
        const data = snapshot.val();
        offers = data ? Object.values(data) : [];
        saveLS(LS_KEYS.OFFERS, offers);
        renderOffers();
        renderApplyOffers();
        notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'info');
      }, (error) => {
        console.error("Firebase error: ", error);
        offers = [];
        renderOffers();
        renderApplyOffers();
        notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'warning');
      });
    }
    function syncOrdersFromFirebase() {
      database.ref('orders').on('value', (snapshot) => {
        const data = snapshot.val();
        orders = data ? Object.values(data) : [];
        saveLS(LS_KEYS.ORDERS, orders);
        renderOrders();
        updateReports();
        renderEpot();
        notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'info');
      }, (error) => {
        console.error("Firebase error: ", error);
        orders = [];
        renderOrders();
        updateReports();
        renderEpot();
        notify('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'warning');
      });
    }
    // --- Menu rendering ---
    function renderMenu() {
      if (!menuContainer) return;
      menuContainer.innerHTML = '';
      Object.keys(menu).forEach((cat) => {
        const sec = document.createElement('div');
        sec.className = 'menu-section';
        sec.innerHTML = `<div class="section-title">${cat}</div><div class="menu-grid" id="grid-${cat}"></div>`;
        menuContainer.appendChild(sec);
        const grid = sec.querySelector('.menu-grid');
        menu[cat].forEach((item) => {
          const card = document.createElement('div');
          card.className = 'menu-item';
          card.dataset.id = item.id;
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h4>${item.name}</h4>
              <div class="small">${item.available ? '' : '<span class="small" style="color:#f97316">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>'}</div>
            </div>
            <div class="price">${item.price} Ø¬</div>
            <div>
              <button class="add-cart" ${!item.available ? 'disabled' : ''}>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
            </div>
          `;
          card.addEventListener('click', () => {
            if (item.available) addToCart(item.id, 1);
          });
          let timeout;
          card.addEventListener('mousedown', () => {
            timeout = setTimeout(() => {
              currentItemForQty = item.id;
              customQty.value = 1;
              qtyModal.style.display = 'flex';
              customQty.focus();
            }, 500);
          });
          card.addEventListener('mouseup', () => clearTimeout(timeout));
          card.addEventListener('mouseleave', () => clearTimeout(timeout));
          grid.appendChild(card);
        });
      });
    }
    // --- Custom qty add ---
    function addCustomQty() {
      const qty = Number(customQty.value);
      if (isNaN(qty) || qty <= 0 || !currentItemForQty) return;
      addToCart(currentItemForQty, qty);
      qtyModal.style.display = 'none';
      currentItemForQty = null;
    }
    // --- Cart ---
    function addToCart(itemId, qty) {
      const it = findItemById(itemId);
      if (!it || !it.available) {
        notify('Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
        return;
      }
      const existing = cart.find((c) => c.id === it.id);
      if (existing) {
        existing.qty += qty;
      } else {
        cart.push({ id: it.id, name: it.name, price: it.price, qty });
      }
      updateCartDisplay();
      notify(`${it.name} ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø³Ù„Ø©`, 'success');
      cartPanel.classList.add('open');
    }
    function updateCartDisplay() {
      if (!cartItemsEl) return;
      cartItemsEl.innerHTML = '';
      bottomCart.innerHTML = cartItemsEl.innerHTML;
      if (cart.length === 0) {
        cartItemsEl.innerHTML = '<div class="small" style="text-align: center; padding: 8px; color: var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
        cartTotalEl.textContent = '0 Ø¬';
        return;
      }
      let total = 0;
      cart.forEach((c, idx) => {
        const line = document.createElement('div');
        line.className = 'cart-item';
        const itemTotal = c.qty * c.price;
        total += itemTotal;
        line.innerHTML = `<div><strong>${c.name}</strong><div class="small">${c.qty} Ã— ${c.price} Ø¬</div></div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px">
            <div style="font-weight: bold">${itemTotal} Ø¬</div>
            <div style="display: flex; gap: 6px">
              <button class="small" style="background: transparent; border: 0; color: var(--muted); cursor: pointer" onclick="cartDecrease(${idx})">-</button>
              <button class="small" style="background: transparent; border: 0; color: var(--muted); cursor: pointer" onclick="cartIncrease(${idx})">+</button>
              <button class="small" style="background: #dc2626; color: #fff; border-radius: 6px; padding: 4px 8px; border: 0; cursor: pointer" onclick="cartRemove(${idx})">Ø­Ø°Ù</button>
            </div>
          </div>`;
        cartItemsEl.appendChild(line);
      });
      const offerId = applyOfferSelect.value;
      let final = total;
      if (offerId) {
        const of = offers.find((o) => o.id === offerId);
        if (of) {
          final = Math.round(total * (1 - of.discount / 100));
        }
      }
      cartTotalEl.textContent = `${final} Ø¬`;
    }
    function cartRemove(idx) {
      cart.splice(idx, 1);
      updateCartDisplay();
      saveState();
    }
    function cartIncrease(idx) {
      cart[idx].qty++;
      updateCartDisplay();
    }
    function cartDecrease(idx) {
      if (cart[idx].qty > 1) {
        cart[idx].qty--;
      } else cart.splice(idx, 1);
      updateCartDisplay();
      saveState();
    }
    // --- Scroll handler for bottom cart ---
    function handleScrollForCart() {
      const bottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 50;
      if (bottom && cart.length > 0) {
        bottomCart.style.display = 'block';
        bottomCart.innerHTML = cartPanel.innerHTML;
      } else {
        bottomCart.style.display = 'none';
      }
    }
    // --- Checkout flow ---
    function openCheckout() {
      if (cart.length === 0) {
        notify('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'warning');
        return;
      }
      if (currentCustomer) {
        orderName.value = currentCustomer.name || '';
        orderPhone.value = currentCustomer.phone || '';
      }
      checkoutSection.style.display = 'block';
      checkoutSection.scrollIntoView({ behavior: 'smooth' });
    }
    function confirmOrder() {
      const name = orderName.value.trim();
      const phone = orderPhone.value.trim();
      const address = orderAddress.value.trim();
      const payment = orderPayment.value;
      const notes = orderNotes.value.trim();
      const offerId = applyOfferSelect.value;
      if (!name || !phone || !address) {
        notify('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨', 'warning');
        return;
      }
      currentCustomer = { name, phone };
      saveState();
      cartCustomerInfo.textContent = `${name} â€” ${phone}`;
      const orderId = 'ORD-' + ++orderCounter;
      localStorage.setItem(LS_KEYS.ORDER_COUNTER, String(orderCounter));
      const totalBefore = cart.reduce((s, c) => s + c.price * c.qty, 0);
      let total = totalBefore;
      let appliedOffer = null;
      if (offerId) {
        const o = offers.find((x) => x.id === offerId);
        if (o) {
          appliedOffer = { id: o.id, name: o.name, discount: o.discount };
          total = Math.round(total * (1 - o.discount / 100));
        }
      }
      const newOrder = {
        id: orderId,
        customer: { name, phone, address },
        items: cart.map((c) => ({ id: c.id, name: c.name, price: c.price, qty: c.qty })),
        totalBefore,
        total,
        payment,
        notes,
        status: 'received',
        createdAt: new Date().toLocaleString('ar-EG'),
        date: new Date().toDateString(),
        appliedOffer
      };
      newOrder.items.forEach((it) => {
        const mItem = findItemById(it.id);
        if (mItem) {
          mItem.sold = (mItem.sold || 0) + it.qty;
        }
      });
      database
        .ref('orders/' + orderId)
        .set(newOrder)
        .then(() => {
          database.ref('menu').set(menu);
          orders.unshift(newOrder);
          saveState();
          cart = [];
          updateCartDisplay();
          checkoutSection.style.display = 'none';
          cartPanel.classList.remove('open');
          notify(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${orderId}`, 'success');
          renderOrders();
          updateReports();
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨: ' + error.message, 'error');
        });
      broadcast({ type: 'order_created', payload: newOrder });
    }
    // --- Operator logic ---
    function onOperatorQuickClick() {
      if (!isOperatorAuthenticated) {
        pwdModal.style.display = 'flex';
        quickPwdInput.value = '';
        quickPwdInput.focus();
      } else {
        if (mainOperator.style.display === 'none') {
          mainOperator.style.display = 'block';
          mainCustomer.style.display = 'none';
        } else {
          mainOperator.style.display = 'none';
          mainCustomer.style.display = 'block';
        }
      }
    }
    function onSubmitQuickPwd() {
      const v = quickPwdInput.value || '';
      if (v === operatorPassword) {
        isOperatorAuthenticated = true;
        pwdModal.style.display = 'none';
        quickPwdInput.value = '';
        mainOperator.style.display = 'block';
        mainCustomer.style.display = 'none';
        operatorLoginPanel.style.display = 'none';
        operatorDashboard.style.display = 'block';
        operatorHint.textContent = 'Ù…Ø´ØºÙ„ Ù…Ø¤Ù…Ù†';
        notify('Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„ Ù†Ø§Ø¬Ø­', 'success');
        renderOrders();
        renderOffers();
        updateReports();
        updateEditControls();
      } else {
        notify('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
      }
    }
    function operatorLogin() {
      const val = operatorPasswordInput.value;
      if (val === operatorPassword) {
        isOperatorAuthenticated = true;
        operatorLoginPanel.style.display = 'none';
        operatorDashboard.style.display = 'block';
        operatorHint.textContent = 'Ù…Ø´ØºÙ„ Ù…Ø¤Ù…Ù†';
        notify('Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„ Ù†Ø§Ø¬Ø­', 'success');
        renderOrders();
        renderOffers();
        updateReports();
        updateEditControls();
      } else {
        notify('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
      }
    }
    function operatorLogout() {
      isOperatorAuthenticated = false;
      operatorLoginPanel.style.display = 'block';
      operatorDashboard.style.display = 'none';
      operatorHint.textContent = 'Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬';
      mainOperator.style.display = 'none';
      mainCustomer.style.display = 'block';
      epotAuthenticated = false;
      updateEditControls();
      notify('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'info');
    }
    // --- EPOT ---
    function unlockEpot() {
      const v = epotPwdInput.value || '';
      if (v === epotPassword) {
        epotAuthenticated = true;
        epotModal.style.display = 'none';
        notify('ØªÙ… ÙØªØ­ EPOT', 'success');
        showEpotContent();
        updateEditControls();
      } else {
        notify('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT Ø®Ø§Ø·Ø¦Ø©', 'error');
      }
    }
    function lockEpot() {
      epotAuthenticated = false;
      updateEditControls();
      epotContent.style.display = 'none';
      epotLockedNotice.style.display = 'block';
      lockEpotBtn.style.display = 'none';
      openEpotBtn.style.display = 'inline-block';
      notify('ØªÙ… Ù‚ÙÙ„ EPOT', 'info');
    }
    function showEpotContent() {
      epotLockedNotice.style.display = 'none';
      epotContent.style.display = 'block';
      lockEpotBtn.style.display = 'inline-block';
      openEpotBtn.style.display = 'none';
      renderEpot();
      renderManageItems();
      populateCategories();
    }
    function setNewEpotPwd() {
      const v = newEpotPwd.value.trim();
      if (!v) {
        notify('Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©', 'warning');
        return;
      }
      epotPassword = v;
      localStorage.setItem(LS_KEYS.EPOT_PWD, epotPassword);
      newEpotPwd.value = '';
      notify('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT', 'success');
    }
    // --- Render orders for operator ---
    function renderOrders() {
      if (!ordersGrid) return;
      ordersGrid.innerHTML = '';
      if (orders.length === 0) {
        ordersGrid.innerHTML = '<div class="small" style="text-align: center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
        return;
      }
      orders.forEach((o) => {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.dataset.id = o.id;
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center">
            <div>
              <div><strong>Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${o.id}</strong></div>
              <div class="small">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${o.customer.name} - ${o.customer.phone}</div>
              <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${o.createdAt}</div>
            </div>
            <div><span class="badge">${o.status}</span></div>
          </div>
          <div class="order-details" id="details-${o.id}">
            <div style="margin-top: 8px">
              <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${o.customer.name} â€” <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.customer.phone}</div>
              <div class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${o.customer.address}</div>
              <div class="small">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: ${o.payment}</div>
              ${o.notes ? `<div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes}</div>` : ''}
            </div>
            <div style="margin-top: 10px; padding: 8px; background: rgba(255, 255, 255, 0.02); border-radius: 8px">
              ${o.items
                .map(
                  (i) => `<div style="display: flex; justify-content: space-between"><div>${i.name} Ã— ${i.qty}</div><div>${i.price * i.qty} Ø¬</div></div>`
                )
                .join('')}
              <div style="margin-top: 8px; font-weight: bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬</div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 8px">
              ${
                o.status === 'received'
                  ? `<button class="btn" onclick="changeOrderStatus('${o.id}', 'preparing')">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>`
                  : ''
              }
              ${
                o.status === 'preparing'
                  ? `<button class="btn" onclick="changeOrderStatus('${o.id}', 'ready')">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>`
                  : ''
              }
              ${
                o.status === 'ready'
                  ? `<button class="btn secondary" onclick="changeOrderStatus('${o.id}', 'delivered')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>`
                  : ''
              }
              <button class="btn secondary" onclick="printOrder('${o.id}')">Ø·Ø¨Ø§Ø¹Ø©/ØªÙØ§ØµÙŠÙ„</button>
            </div>
          </div>
        `;
        card.addEventListener('click', () => toggleOrderDetails(o.id));
        ordersGrid.appendChild(card);
        if (openOrderId === o.id) toggleOrderDetails(o.id);
      });
    }
    function toggleOrderDetails(id) {
      const details = document.getElementById(`details-${id}`);
      if (details.classList.contains('open')) {
        details.classList.remove('open');
      } else {
        document.querySelectorAll('.order-details.open').forEach((d) => d.classList.remove('open'));
        details.classList.add('open');
      }
    }
    function changeOrderStatus(orderId, newStatus) {
      const ord = orders.find((o) => o.id === orderId);
      if (!ord) return;
      ord.status = newStatus;
      database
        .ref('orders/' + orderId)
        .update({ status: newStatus })
        .then(() => {
          saveState();
          renderOrders();
          updateReports();
          notify(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ${orderId} Ø¥Ù„Ù‰ ${newStatus}`, 'success');
          if (newStatus === 'delivered') {
            const details = document.getElementById(`details-${orderId}`);
            if (details) details.classList.remove('open');
          }
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ' + error.message, 'error');
        });
      broadcast({ type: 'order_status_update', payload: { id: orderId, status: newStatus } });
    }
    function printOrder(orderId) {
      const ord = orders.find((o) => o.id === orderId);
      if (!ord) return;
      const win = window.open('', '_blank');
      win.document.write(`<pre>${JSON.stringify(ord, null, 2)}</pre>`);
    }
    // --- Offers ---
    function renderApplyOffers() {
      if (!applyOfferSelect) return;
      applyOfferSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
      offers.forEach((o) => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = `${o.name} â€” ${o.discount}%`;
        applyOfferSelect.appendChild(opt);
      });
    }
    function renderOffers() {
      if (!activeOffersList) return;
      activeOffersList.innerHTML = '';
      if (offers.length === 0) {
        activeOffersList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</div>';
        return;
      }
      offers.forEach((o) => {
        const d = document.createElement('div');
        d.className = 'card small';
        d.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center">
          <div><strong>${o.name}</strong><div class="small">Ø®ØµÙ… ${o.discount}%</div></div>
          <div><button class="btn secondary" onclick="removeOffer('${o.id}')">Ø¥Ù„ØºØ§Ø¡</button></div>
        </div>`;
        activeOffersList.appendChild(d);
      });
      renderApplyOffers();
    }
    function createOffer() {
      if (!checkEditAuth()) {
        notify('Ù…Ø·Ù„ÙˆØ¨ ØµÙ„Ø§Ø­ÙŠØ© EPOT Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±ÙˆØ¶', 'warning');
        epotModal.style.display = 'flex';
        return;
      }
      const name = offerName.value.trim();
      const discount = Number(offerDiscount.value);
      if (!name || isNaN(discount) || discount < 0 || discount > 100) {
        notify('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }
      const id = generateId('offer');
      const newOffer = { id, name, discount, created: new Date().toLocaleDateString('ar-EG') };
      offers.push(newOffer);
      database
        .ref('offers/' + id)
        .set(newOffer)
        .then(() => {
          saveState();
          offerName.value = '';
          offerDiscount.value = '';
          renderOffers();
          notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶', 'success');
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶: ' + error.message, 'error');
        });
      broadcast({ type: 'offer_update', payload: offers });
    }
    function removeOffer(id) {
      if (!checkEditAuth()) {
        notify('Ù…Ø·Ù„ÙˆØ¨ ØµÙ„Ø§Ø­ÙŠØ© EPOT Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±ÙˆØ¶', 'warning');
        epotModal.style.display = 'flex';
        return;
      }
      offers = offers.filter((o) => o.id !== id);
      database
        .ref('offers/' + id)
        .remove()
        .then(() => {
          saveState();
          renderOffers();
          notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶', 'info');
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶: ' + error.message, 'error');
        });
      broadcast({ type: 'offer_update', payload: offers });
    }
    // --- Manage Items ---
    function renderManageItems() {
      if (!manageItemsList) return;
      manageItemsList.innerHTML = '';
      Object.keys(menu).forEach((cat) => {
        const catSection = document.createElement('div');
        catSection.style.marginBottom = '16px';
        catSection.innerHTML = `<h4 class="small" style="color: var(--gold); margin-bottom: 8px">${cat}</h4>`;
        menu[cat].forEach((item) => {
          const itemCard = document.createElement('div');
          itemCard.className = 'card small';
          itemCard.style.marginBottom = '8px';
          itemCard.style.padding = '10px';
          itemCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px">
              <div style="flex: 1">
                <input class="input" value="${item.name}" id="name_${item.id}" style="margin-bottom: 6px" />
                <div style="display: flex; gap: 8px; align-items: center">
                  <input class="input" type="number" value="${item.price}" id="price_${item.id}" style="width: 100px" />
                  <span class="small">Ø¬</span>
                  <span class="small" style="color: var(--muted)">Ù…Ø¨ÙŠØ¹: ${item.sold || 0}</span>
                  <span class="badge" style="background: ${item.available ? 'var(--success)' : '#dc2626'}">${item.available ? 'Ù…ØªØ§Ø­' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}</span>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px">
                <button class="btn small-inline" onclick="saveItemChanges('${item.id}')">Ø­ÙØ¸</button>
                <button class="btn small-inline" style="background: #dc2626; color: #fff" onclick="removeItem('${item.id}')">Ø­Ø°Ù</button>
              </div>
            </div>
          `;
          manageItemsList.appendChild(catSection);
          catSection.appendChild(itemCard);
        });
      });
    }
    function addNewItem() {
      if (!checkEditAuth()) {
        notify('Ù…Ø·Ù„ÙˆØ¨ ØµÙ„Ø§Ø­ÙŠØ© EPOT Ù„Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù', 'warning');
        epotModal.style.display = 'flex';
        return;
      }
      const name = newItemName.value.trim();
      const price = Number(newItemPrice.value);
      const category = newItemCategory.value;
      if (!name || isNaN(price) || price < 0 || !category) {
        notify('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }
      const id = generateId('item');
      const newItem = { id, name, price, available: true, sold: 0 };
      if (!menu[category]) menu[category] = [];
      menu[category].push(newItem);
      database
               .ref('menu/' + category)
        .set(menu[category])
        .then(() => {
          saveState();
          newItemName.value = '';
          newItemPrice.value = '';
          renderMenu();
          renderManageItems();
          notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù', 'success');
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù: ' + error.message, 'error');
        });
      broadcast({ type: 'menu_update', payload: menu });
    }
    function saveItemChanges(itemId) {
      if (!checkEditAuth()) {
        notify('Ù…Ø·Ù„ÙˆØ¨ ØµÙ„Ø§Ø­ÙŠØ© EPOT Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù', 'warning');
        epotModal.style.display = 'flex';
        return;
      }
      const name = document.getElementById(`name_${itemId}`).value.trim();
      const price = Number(document.getElementById(`price_${itemId}`).value);
      if (!name || isNaN(price) || price < 0) {
        notify('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }
      for (const cat in menu) {
        const item = menu[cat].find((i) => i.id === itemId);
        if (item) {
          item.name = name;
          item.price = price;
          break;
        }
      }
      database
        .ref('menu')
        .set(menu)
        .then(() => {
          saveState();
          renderMenu();
          renderManageItems();
          notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù', 'success');
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù: ' + error.message, 'error');
        });
      broadcast({ type: 'menu_update', payload: menu });
    }
    function removeItem(itemId) {
      if (!checkEditAuth()) {
        notify('Ù…Ø·Ù„ÙˆØ¨ ØµÙ„Ø§Ø­ÙŠØ© EPOT Ù„Ø­Ø°Ù Ø§Ù„Ø£ØµÙ†Ø§Ù', 'warning');
        epotModal.style.display = 'flex';
        return;
      }
      for (const cat in menu) {
        const idx = menu[cat].findIndex((i) => i.id === itemId);
        if (idx !== -1) {
          menu[cat].splice(idx, 1);
          break;
        }
      }
      database
        .ref('menu')
        .set(menu)
        .then(() => {
          saveState();
          renderMenu();
          renderManageItems();
          notify('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù', 'success');
        })
        .catch((error) => {
          notify('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ†Ù: ' + error.message, 'error');
        });
      broadcast({ type: 'menu_update', payload: menu });
    }
    function populateCategories() {
      if (!newItemCategory) return;
      newItemCategory.innerHTML = '';
      Object.keys(menu).forEach((cat) => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        newItemCategory.appendChild(opt);
      });
    }
    // --- Reports ---
    function updateReports() {
      if (!rToday || !rRevenue || !rTotal || !rTop || !popularList) return;
      const today = new Date().toDateString();
      const todayOrders = orders.filter((o) => o.date === today);
      rToday.textContent = todayOrders.length;
      rRevenue.textContent = todayOrders.reduce((s, o) => s + o.total, 0);
      rTotal.textContent = orders.length;
      const itemSales = {};
      orders.forEach((o) =>
        o.items.forEach((i) => {
          itemSales[i.id] = (itemSales[i.id] || 0) + i.qty;
        })
      );
      const topItem = Object.entries(itemSales).reduce(
        (max, curr) => (curr[1] > max[1] ? curr : max),
        ['-', 0]
      );
      rTop.textContent = topItem[0] !== '-' ? findItemById(topItem[0]).name : '-';
      popularList.innerHTML = '';
      const topItems = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([id, qty]) => {
          const item = findItemById(id);
          return item ? `${item.name} (${qty} Ù…Ø±Ø©)` : '';
        })
        .filter((x) => x);
      if (topItems.length > 0) {
        popularList.innerHTML = `<ul style="margin: 0; padding: 0 0 0 16px">${topItems
          .map((i) => `<li class="small">${i}</li>`)
          .join('')}</ul>`;
      }
    }
    // --- EPOT Orders ---
    function renderEpot() {
      if (!epotOrdersList || !epotTotal) return;
      epotOrdersList.innerHTML = '';
      const totalRevenue = orders.reduce((s, o) => s + o.total, 0);
      epotTotal.textContent = totalRevenue;
      orders.forEach((o) => {
        const card = document.createElement('div');
        card.className = 'card small';
        card.style.marginBottom = '8px';
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center">
            <div><strong>Ø·Ù„Ø¨: ${o.id}</strong><div class="small">${o.createdAt}</div></div>
            <div><span class="badge">${o.status}</span></div>
          </div>
          <div style="margin-top: 8px">
            <div class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬</div>
            <div class="small">Ø§Ù„Ø¯ÙØ¹: ${o.payment}</div>
          </div>
        `;
        epotOrdersList.appendChild(card);
      });
    }
    // --- Export ---
    function exportAllData() {
      const data = {
        menu,
        orders,
        offers,
        stats: {
          totalOrders: orders.length,
          totalRevenue: orders.reduce((s, o) => s + o.total, 0),
          todayOrders: orders.filter((o) => o.date === new Date().toDateString()).length
        }
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `koshary_abosamra_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      notify('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    // --- Helpers ---
    function findItemById(id) {
      for (const cat in menu) {
        const item = menu[cat].find((i) => i.id === id);
        if (item) return item;
      }
      return null;
    }
    function saveState() {
      saveLS(LS_KEYS.MENU, menu);
      saveLS(LS_KEYS.ORDERS, orders);
      saveLS(LS_KEYS.OFFERS, offers);
      saveLS(LS_KEYS.CUST, currentCustomer);
    }
    function notify(msg, type = 'info') {
      const notifyEl = document.getElementById('notify');
      if (!notifyEl) return;
      notifyEl.textContent = msg;
      notifyEl.style.background = type === 'error' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#16a34a';
      notifyEl.style.display = 'block';
      setTimeout(() => (notifyEl.style.display = 'none'), 3000);
    }
    function checkEditAuth() {
      return isOperatorAuthenticated && epotAuthenticated;
    }
    function updateEditControls() {
      const editControls = [addItemBtn, newItemName, newItemPrice, newItemCategory, createOfferBtn, offerName, offerDiscount];
      editControls.forEach((el) => {
        if (el) el.disabled = !checkEditAuth();
      });
      offerNotice.style.display = checkEditAuth() ? 'none' : 'block';
    }
    // --- Global event listeners ---
    window.cartIncrease = cartIncrease;
    window.cartDecrease = cartDecrease;
    window.cartRemove = cartRemove;
    window.changeOrderStatus = changeOrderStatus;
    window.printOrder = printOrder;
    window.saveItemChanges = saveItemChanges;
    window.removeItem = removeItem;
  </script>
</body>
</html>
