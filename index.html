<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>كشري أبو سمرة</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <style>
    :root {
      --bg: #1a120b;
      --card: #2d1b0f;
      --accent: #d35400;
      --gold: #f39c12;
      --text: #f5e6cc;
      --muted: #b89778;
      --success: #27ae60;
      --warning: #e67e22;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Tajawal', Tahoma, sans-serif;
      background: linear-gradient(135deg, #1a120b, #2d1b0f);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 12px; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--card); padding: 12px; border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4); margin-bottom: 16px;
    }
    .brand h1 { font-size: 1.5rem; color: var(--gold); margin: 0; }
    .brand p { font-size: 0.8rem; color: var(--muted); }

    /* أزرار الأيقونات */
    .icon-btn {
      width: 48px; height: 48px; border-radius: 50%; background: var(--accent);
      color: #fff; border: none; font-size: 20px; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center;
      justify-content: center; position: relative;
    }
    .icon-btn[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
      background: #000; color: #fff; padding: 6px 10px; border-radius: 6px;
      font-size: 0.8rem; white-space: nowrap; z-index: 10;
    }

    .tabs {
      display: flex; gap: 8px; overflow-x: auto; padding: 8px 0;
      scrollbar-width: none; white-space: nowrap;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      padding: 10px 16px; background: var(--card); border-radius: 12px;
      font-weight: bold; cursor: pointer; min-width: fit-content;
      transition: all 0.3s; display: flex; align-items: center; gap: 6px;
    }
    .tab.active { background: var(--gold); color: #1a120b; }
    .tab i { font-size: 18px; }

    .menu-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px; margin-top: 12px;
    }
    .menu-item {
      background: var(--card); border-radius: 16px; padding: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .menu-item:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(211,84,0,0.3); }
    .menu-item h4 { margin: 0 0 6px; font-size: 1rem; }
    .price { font-weight: bold; color: var(--gold); font-size: 1.1rem; }
    .add-cart {
      background: var(--success); color: #fff; border: none;
      padding: 8px 12px; border-radius: 10px; width: 100%; margin-top: 8px;
      font-weight: bold; cursor: pointer; display: flex; align-items: center;
      justify-content: center; gap: 6px;
    }
    .add-cart:disabled { background: #555; cursor: not-allowed; }

    .cart-toggle {
      position: fixed; bottom: 20px; right: 20px; z-index: 9999;
      width: 64px; height: 64px; border-radius: 50%; background: var(--accent);
      color: #fff; border: none; font-size: 28px; box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
    }
    .cart-panel {
      position: fixed; top: 0; right: -100%; width: 100%; max-width: 380px;
      height: 100vh; background: var(--card); padding: 16px; z-index: 999;
      transition: right 0.4s; box-shadow: -8px 0 20px rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    .cart-panel.open { right: 0; }
    .cart-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .badge { background: var(--gold); color: #1a120b; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

    .section-title { background: var(--gold); color: #1a120b; padding: 10px; border-radius: 12px; text-align: center; font-weight: bold; }

    .input, select, textarea {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,215,0,0.2);
      background: rgba(255,255,255,0.05); color: var(--text); margin-bottom: 8px;
    }

    .btn {
      background: var(--accent); color: #fff; padding: 10px 16px; border: none;
      border-radius: 10px; cursor: pointer; font-weight: bold; display: flex;
      align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem;
    }
    .btn.secondary { background: #555; }
    .btn.small { padding: 6px 10px; font-size: 0.8rem; }

    .notify {
      position: fixed; bottom: 90px; right: 20px; padding: 12px 20px; border-radius: 12px;
      background: var(--success); color: #fff; z-index: 9999; display: none; font-weight: bold;
    }

    .profile-menu {
      position: fixed; top: 70px; right: 16px; background: var(--card); padding: 12px;
      border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.5); z-index: 99999; display: none;
      width: 220px;
    }
    .profile-menu.show { display: block; }
    .profile-menu button { width: 100%; margin-bottom: 8px; justify-content: center; }

    .order-status-badge {
      position: fixed; top: 16px; left: 16px; background: var(--success); color: #fff;
      padding: 8px 16px; border-radius: 12px; font-weight: bold; z-index: 9998; display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .search-bar { margin: 12px 0; position: relative; }
    .search-bar input {
      width: 100%; padding: 10px 36px 10px 12px; border-radius: 12px;
      border: 1px solid var(--gold); background: rgba(255,255,255,0.1); color: var(--text);
    }
    .search-bar::after {
      content: '\f002'; font-family: 'tabler-icons'; position: absolute; left: 12px; top: 10px;
      color: var(--gold); font-size: 18px;
    }

    @media (max-width: 600px) {
      .menu-grid { grid-template-columns: 1fr; }
      .cart-panel { width: 100%; }
      .icon-btn { width: 44px; height: 44px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="brand">
      <h1>كشري أبو سمرة</h1>
      <p>نظام طلبات كامل</p>
    </div>
    <button class="icon-btn" id="profileBtn" data-tooltip="إعدادات المشغل">
      <i class="ti ti-user"></i>
    </button>
  </div>

  <!-- Tabs with horizontal scroll + icons -->
  <div class="tabs" id="categoryTabs"></div>

  <div id="menuContainer" class="menu-grid"></div>

  <div id="checkoutSection" style="display:none; margin-top:20px">
    <div class="section-title">إتمام الطلب</div>
    <input id="orderName" class="input" placeholder="الاسم الكامل" />
    <input id="orderPhone" class="input" placeholder="رقم الهاتف" />
    <input id="orderAddress" class="input" placeholder="العنوان بالتفصيل" />
    <select id="orderPayment" class="input">
      <option value="cash">نقدًا</option>
      <option value="vodafone">فودافون كاش</option>
    </select>
    <textarea id="orderNotes" class="input" placeholder="ملاحظات (اختياري)"></textarea>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" id="confirmOrderBtn" style="flex:1"><i class="ti ti-check"></i> تأكيد</button>
      <button class="btn secondary" id="cancelCheckoutBtn"><i class="ti ti-x"></i> إلغاء</button>
    </div>
  </div>
</div>

<!-- Cart Toggle -->
<button class="cart-toggle" id="cartToggle" data-tooltip="سلة المشتريات">
  <i class="ti ti-shopping-cart"></i>
</button>

<!-- Cart Panel -->
<div class="cart-panel" id="cartPanel">
  <div style="font-weight:bold; font-size:1.2rem; margin-bottom:12px; display:flex; align-items:center; gap:8px">
    <i class="ti ti-shopping-cart"></i> سلة المشتريات
  </div>
  <div id="cartCustomerInfo" class="small" style="color:var(--muted)">ضيف</div>
  <div id="cartItems" style="margin:12px 0"></div>
  <div style="display:flex; justify-content:space-between; align-items:center; margin:12px 0">
    <div class="badge" id="cartTotal">0 ج</div>
    <select id="applyOffer" class="input" style="width:auto; padding:6px"></select>
  </div>
  <button class="btn" id="checkoutBtn" style="width:100%"><i class="ti ti-credit-card"></i> إتمام الطلب</button>
  <button class="btn secondary" id="clearCartBtn" style="width:100%; margin-top:8px"><i class="ti ti-trash"></i> تفريغ</button>
</div>

<!-- Profile Menu -->
<div class="profile-menu" id="profileMenu">
  <button class="btn secondary" id="operatorLoginBtn"><i class="ti ti-login"></i> دخول المشغل</button>
  <button class="btn secondary" id="operatorLogoutBtn" style="display:none"><i class="ti ti-logout"></i> خروج</button>
</div>

<!-- Operator Dashboard -->
<div id="mainOperator" class="container" style="display:none; margin-top:20px">
  <div class="tabs" id="opTabs">
    <div class="tab active" data-tab="ordersTab"><i class="ti ti-list"></i> الطلبات</div>
    <div class="tab" data-tab="epotTab"><i class="ti ti-lock"></i> EPOT</div>
  </div>

  <div id="ordersTab" class="tabContent">
    <div class="search-bar"><input type="text" id="searchOrders" placeholder="بحث..."></div>
    <div id="ordersGrid"></div>
  </div>

  <div id="epotTab" class="tabContent" style="display:none">
    <button class="btn" id="endDayBtn" style="width:100%; margin-bottom:12px"><i class="ti ti-calendar-off"></i> إنهاء اليوم</button>
    <div class="section-title"><i class="ti ti-archive"></i> طلبات مسبقة</div>
    <div class="search-bar"><input type="text" id="searchArchived" placeholder="بحث..."></div>
    <div id="archivedOrders"></div>
  </div>
</div>

<div class="notify" id="notify"></div>
<div class="order-status-badge" id="orderStatusBadge"></div>

<script>
  // --- Firebase ---
  const firebaseConfig = { /* نفس الإعدادات */ };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- State & Storage ---
  let menu = {}, orders = [], archivedOrders = [], offers = [], cart = [];
  let currentCustomer = null, isOperator = false, currentPhone = null;
  let bonCounter = Number(localStorage.getItem('bonCounter') || 1);

  const LS = { save: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
               load: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } } };

  // --- DOM ---
  const profileBtn = document.getElementById('profileBtn');
  const profileMenu = document.getElementById('profileMenu');
  const cartToggle = document.getElementById('cartToggle');
  const cartPanel = document.getElementById('cartPanel');
  const menuContainer = document.getElementById('menuContainer');
  const cartItemsEl = document.getElementById('cartItems');
  const cartTotalEl = document.getElementById('cartTotal');
  const applyOfferSelect = document.getElementById('applyOffer');
  const operatorLoginBtn = document.getElementById('operatorLoginBtn');
  const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');
  const mainOperator = document.getElementById('mainOperator');
  const opTabs = document.getElementById('opTabs');
  const ordersGrid = document.getElementById('ordersGrid');
  const searchOrders = document.getElementById('searchOrders');
  const archivedOrdersEl = document.getElementById('archivedOrders');
  const searchArchived = document.getElementById('searchArchived');
  const endDayBtn = document.getElementById('endDayBtn');
  const orderStatusBadge = document.getElementById('orderStatusBadge');

  // --- Init ---
  window.onload = () => {
    loadData();
    renderCategoryTabs();
    renderMenu();
    renderApplyOffers();
    renderOrders();
    setupEvents();
    checkCustomerStatus();
    setInterval(checkCustomerStatus, 3000);
  };

  function loadData() {
    menu = LS.load('menu', DEFAULT_MENU);
    orders = LS.load('orders', []);
    archivedOrders = LS.load('archivedOrders', []);
    offers = LS.load('offers', []);
    currentCustomer = LS.load('currentCustomer', null);
    if (currentCustomer) document.getElementById('cartCustomerInfo').innerHTML = `<i class="ti ti-user"></i> ${currentCustomer.name}`;
  }

  function setupEvents() {
    cartToggle.onclick = () => cartPanel.classList.toggle('open');
    profileBtn.onclick = () => profileMenu.classList.toggle('show');
    operatorLoginBtn.onclick = () => { if (prompt('كلمة المرور') === 'admin123') loginOperator(); };
    operatorLogoutBtn.onclick = logoutOperator;
    document.getElementById('checkoutBtn').onclick = () => document.getElementById('checkoutSection').style.display = 'block';
    document.getElementById('confirmOrderBtn').onclick = confirmOrder;
    document.getElementById('cancelCheckoutBtn').onclick = () => document.getElementById('checkoutSection').style.display = 'none';
    document.getElementById('clearCartBtn').onclick = () => { cart = []; updateCart(); };
    endDayBtn.onclick = endDay;
    searchOrders.oninput = renderOrders;
    searchArchived.oninput = renderArchived;
    opTabs.onclick = (e) => { if (e.target.closest('.tab')) switchTab(e.target.closest('.tab').dataset.tab); };
  }

  function renderCategoryTabs() {
    const tabs = document.getElementById('categoryTabs');
    tabs.innerHTML = '';
    Object.keys(menu).forEach(cat => {
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.dataset.tab = cat;
      tab.innerHTML = `<i class="ti ti-package"></i> ${cat}`;
      tab.onclick = () => scrollToCategory(cat);
      tabs.appendChild(tab);
    });
  }

  function scrollToCategory(cat) {
    const el = document.getElementById(`section-${cat}`);
    if (el) el.scrollIntoView({ behavior: 'smooth' });
  }

  function renderMenu() {
    menuContainer.innerHTML = '';
    Object.entries(menu).forEach(([cat, items]) => {
      const sec = document.createElement('div');
      sec.id = `section-${cat}`;
      sec.innerHTML = `<div class="section-title"><i class="ti ti-category"></i> ${cat}</div><div class="menu-grid"></div>`;
      menuContainer.appendChild(sec);
      const grid = sec.querySelector('.menu-grid');
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'menu-item';
        card.innerHTML = `
          <h4>${item.name}</h4>
          <div class="price">${item.price} ج</div>
          <button class="add-cart" ${!item.available ? 'disabled' : ''}><i class="ti ti-plus"></i> إضافة</button>
        `;
        card.onclick = () => { if (item.available) addToCart(item.id, 1); };
        grid.appendChild(card);
      });
    });
  }

  function addToCart(id, qty) {
    const item = findItem(id);
    if (!item || !item.available) return notify('غير متوفر', 'error');
    const existing = cart.find(c => c.id === id);
    if (existing) existing.qty += qty; else cart.push({ ...item, qty });
    updateCart();
    notify(`تم إضافة ${item.name}`);
  }

  function updateCart() {
    cartItemsEl.innerHTML = '';
    let total = 0;
    cart.forEach((c, i) => {
      const line = document.createElement('div');
      line.className = 'cart-item';
      const subtotal = c.price * c.qty;
      total += subtotal;
      line.innerHTML = `<div><strong>${c.name}</strong> × ${c.qty}</div><div>${subtotal} ج</div>`;
      cartItemsEl.appendChild(line);
    });
    const offer = offers.find(o => o.id === applyOfferSelect.value);
    if (offer) total = Math.round(total * (1 - offer.discount / 100));
    cartTotalEl.textContent = total + ' ج';
  }

  function confirmOrder() {
    const name = document.getElementById('orderName').value.trim();
    const phone = document.getElementById('orderPhone').value.trim();
    const address = document.getElementById('orderAddress').value.trim();
    if (!name || !phone || !address) return notify('أكمل البيانات', 'warning');

    currentCustomer = { name, phone };
    currentPhone = phone;
    LS.save('currentCustomer', currentCustomer);

    const order = {
      id: 'ORD-' + Date.now(),
      bonNumber: bonCounter++,
      customer: { name, phone, address },
      items: cart,
      total: cart.reduce((s,c) => s + c.price * c.qty, 0),
      status: 'received',
      createdAt: new Date().toLocaleString('ar-EG')
    };

    orders.unshift(order);
    db.ref('orders/' + order.id).set(order);
    LS.save('orders', orders);
    LS.save('bonCounter', bonCounter);
    cart = [];
    updateCart();
    document.getElementById('checkoutSection').style.display = 'none';
    notify(`طلب #${order.bonNumber} تم`);
    renderOrders();
  }

  function renderOrders() {
    const q = searchOrders.value.toLowerCase();
    const filtered = orders.filter(o =>
      o.bonNumber.toString().includes(q) ||
      o.customer.name.toLowerCase().includes(q) ||
      o.customer.phone.includes(q) ||
      o.customer.address.toLowerCase().includes(q)
    );
    ordersGrid.innerHTML = filtered.map(o => `
      <div class="card" style="margin-bottom:12px; padding:12px">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div><strong>#${o.bonNumber}</strong> ${o.customer.name}</div>
          <span class="badge">${o.status}</span>
        </div>
        <div class="small" style="margin:6px 0">الإجمالي: ${o.total} ج</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap">
          ${o.status === 'received' ? `<button class="btn small" onclick="updateStatus('${o.id}', 'preparing')"><i class="ti ti-cooking-pot"></i></button>` : ''}
          ${o.status === 'preparing' ? `<button class="btn small" onclick="updateStatus('${o.id}', 'ready')"><i class="ti ti-check"></i></button>` : ''}
          ${o.status === 'ready' ? `<button class="btn secondary small" onclick="updateStatus('${o.id}', 'delivered')"><i class="ti ti-truck-delivery"></i></button>` : ''}
          <button class="btn secondary small" style="background:#e74c3c" onclick="cancelOrder('${o.id}')"><i class="ti ti-x"></i></button>
        </div>
      </div>
    `).join('');
  }

  function updateStatus(id, status) {
    const order = orders.find(o => o.id === id);
    if (!order) return;
    order.status = status;
    db.ref('orders/' + id).update({ status });
    LS.save('orders', orders);
    renderOrders();
    if (currentPhone === order.customer.phone) showStatus(status);
  }

  function cancelOrder(id) {
    if (!confirm('إلغاء الطلب؟')) return;
    orders = orders.filter(o => o.id !== id);
    db.ref('orders/' + id).remove();
    LS.save('orders', orders);
    renderOrders();
  }

  function showStatus(status) {
    const msg = status === 'preparing' ? 'قيد التحضير' : 'جاهز للتسليم!';
    orderStatusBadge.innerHTML = `<i class="ti ti-alert-circle"></i> ${msg}`;
    orderStatusBadge.style.display = 'block';
    setTimeout(() => orderStatusBadge.style.display = 'none', 5000);
  }

  function checkCustomerStatus() {
    if (!currentPhone) return;
    const myOrder = orders.find(o => o.customer.phone === currentPhone && ['preparing','ready'].includes(o.status));
    if (myOrder) showStatus(myOrder.status);
  }

  function endDay() {
    if (!confirm('إنهاء اليوم؟')) return;
    archivedOrders = archivedOrders.concat(orders);
    orders = [];
    db.ref('orders').set({});
    LS.save('orders', []);
    LS.save('archivedOrders', archivedOrders);
    renderOrders();
    renderArchived();
    notify('تم إنهاء اليوم');
  }

  function renderArchived() {
    const q = searchArchived.value.toLowerCase();
    const filtered = archivedOrders.filter(o =>
      o.bonNumber.toString().includes(q) ||
      o.customer.name.toLowerCase().includes(q)
    );
    archivedOrdersEl.innerHTML = filtered.map(o => `
      <div class="card small" style="margin-bottom:8px; padding:8px">
        <div><strong>#${o.bonNumber}</strong> ${o.customer.name}</div>
        <div class="small">${o.createdAt} - ${o.total} ج</div>
      </div>
    `).join('');
  }

  function switchTab(tab) {
    document.querySelectorAll('.tabContent').forEach(el => el.style.display = 'none');
    document.getElementById(tab).style.display = 'block';
    document.querySelectorAll('#opTabs .tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    if (tab === 'epotTab') renderArchived();
  }

  function renderApplyOffers() {
    applyOfferSelect.innerHTML = '<option value="">بدون عرض</option>';
    offers.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.id; opt.textContent = `${o.name} (${o.discount}%)`;
      applyOfferSelect.appendChild(opt);
    });
  }

  function findItem(id) {
    for (const cat in menu) {
      const item = menu[cat].find(i => i.id === id);
      if (item) return item;
    }
    return null;
  }

  function notify(msg, type = 'info') {
    const n = document.getElementById('notify');
    n.textContent = msg;
    n.style.background = type === 'error' ? '#e74c3c' : type === 'warning' ? '#e67e22' : '#27ae60';
    n.style.display = 'block';
    setTimeout(() => n.style.display = 'none', 3000);
  }

  // --- Default Menu ---
  const DEFAULT_MENU = { /* نفس القائمة الأصلية */ };

  // Global
  window.updateStatus = updateStatus;
  window.cancelOrder = cancelOrder;
</script>
</body>
</html>
