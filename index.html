<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø© - Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</title>
  <style>
    :root {
      --bg: #1a1410;
      --card: #2d2419;
      --muted: #a89175;
      --accent: #d4a03a;
      --gold: #f4c430;
      --brown: #5c4532;
      --brown-dark: #3d2e1f;
      --success: #7c9b3e;
      --danger: #c4402e;
    }
    * {
      box-sizing: border-box;
    }
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: var(--bg);
      color: #f5f1e8;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }
    .header {
      background: linear-gradient(135deg, var(--brown) 0%, var(--brown-dark) 100%);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--gold);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .profile-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      position: relative;
    }
    .profile-btn:hover {
      transform: scale(1.1);
    }
    .order-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }
    .categories-section {
      background: var(--card);
      padding: 16px 0;
      border-bottom: 2px solid var(--accent);
      position: fixed;
      top: 76px;
      left: 0;
      right: 0;
      z-index: 99;
    }
    .categories-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 0 20px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .categories-scroll::-webkit-scrollbar {
      display: none;
    }
    .category-btn {
      padding: 10px 20px;
      border-radius: 25px;
      background: var(--brown);
      color: #f5f1e8;
      border: 2px solid transparent;
      cursor: pointer;
      white-space: nowrap;
      font-weight: bold;
      transition: all 0.3s;
    }
    .category-btn:hover,
    .category-btn.active {
      background: var(--accent);
      border-color: var(--gold);
      color: #1a1410;
      transform: translateY(-2px);
    }
    .menu-container {
      padding: 20px;
      margin-top: 150px;
    }
    .menu-section {
      margin-bottom: 40px;
      scroll-margin-top: 150px;
    }
    .section-title {
      background: linear-gradient(135deg, var(--gold) 0%, var(--accent) 100%);
      color: #1a1410;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: bold;
      margin-bottom: 16px;
      text-align: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(244, 196, 48, 0.3);
    }
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    .menu-item {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .menu-item:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(244, 196, 48, 0.2);
    }
    .menu-item h4 {
      margin: 0 0 8px 0;
      color: var(--gold);
      font-size: 1.1rem;
    }
    .price {
      color: var(--accent);
      font-weight: bold;
      font-size: 1.2rem;
      margin: 8px 0;
    }
    .add-cart-btn {
      width: 100%;
      padding: 10px;
      background: var(--success);
      color: #fff;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .add-cart-btn:hover {
      background: #6a8435;
      transform: scale(1.05);
    }
    .add-cart-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .cart-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      color: #1a1410;
      border: 3px solid var(--gold);
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 16px rgba(244, 196, 48, 0.4);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .cart-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .cart-panel {
      position: fixed;
      top: 0;
      left: -100%;
      width: 100%;
      max-width: 400px;
      height: 100vh;
      background: var(--card);
      padding: 20px;
      transition: left 0.3s;
      z-index: 10000;
      overflow-y: auto;
      box-shadow: 4px 0 20px rgba(0,0,0,0.5);
    }
    .cart-panel.open {
      left: 0;
    }
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--accent);
    }
    .cart-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--gold);
    }
    .close-cart {
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      line-height: 1;
    }
    .cart-items {
      margin-bottom: 20px;
    }
    .cart-item {
      background: var(--brown-dark);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-total {
      background: var(--gold);
      color: #1a1410;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      margin: 16px 0;
    }
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary {
      background: var(--success);
      color: #fff;
    }
    .btn-primary:hover {
      background: #6a8435;
    }
    .btn-secondary {
      background: var(--brown);
      color: #f5f1e8;
    }
    .btn-secondary:hover {
      background: var(--brown-dark);
    }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    }
    .modal.open {
      display: flex;
    }
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid var(--accent);
    }
    .modal-title {
      color: var(--gold);
      font-size: 1.5rem;
      margin-bottom: 16px;
      text-align: center;
    }
    .input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid var(--brown);
      background: var(--brown-dark);
      color: #f5f1e8;
      margin-bottom: 12px;
      font-size: 1rem;
    }
    .input:focus {
      outline: none;
      border-color: var(--accent);
    }
    select.input {
      cursor: pointer;
    }
    textarea.input {
      min-height: 80px;
      resize: vertical;
    }
    .checkout-section {
      display: none;
      padding: 20px;
      background: var(--card);
      margin: 20px;
      border-radius: 12px;
      border: 2px solid var(--accent);
    }
    .operator-dashboard {
      display: none;
      padding: 20px;
      padding-top: 100px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 12px 24px;
      background: var(--brown);
      color: #f5f1e8;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab.active {
      background: var(--accent);
      color: #1a1410;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .order-card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .order-card:hover {
      border-color: var(--accent);
    }
    .order-card.cancelled {
      opacity: 0.6;
      border-color: var(--danger);
    }
    .order-details {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: var(--brown-dark);
      border-radius: 8px;
    }
    .order-details.open {
      display: block;
    }
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .badge-received {
      background: #3b82f6;
      color: #fff;
    }
    .badge-preparing {
      background: #f59e0b;
      color: #1a1410;
    }
    .badge-ready {
      background: var(--success);
      color: #fff;
    }
    .badge-delivered {
      background: #6b7280;
      color: #fff;
    }
    .badge-cancelled {
      background: var(--danger);
      color: #fff;
    }
    .notification {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      display: none;
      z-index: 10002;
      animation: slideUp 0.3s;
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    .notification.error {
      background: var(--danger);
    }
    .notification.warning {
      background: #f59e0b;
      color: #1a1410;
    }
    .customer-status {
  background: var(--card);
  padding: 20px;
  margin: 20px;
  margin-top: 170px;
  border-radius: 12px;
  border: 2px solid var(--accent);
  display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø¯Ø§Ø¦Ù… */
}
    .customer-status.show {
      display: block;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar .input {
      flex: 1;
      min-width: 200px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 2px solid var(--brown);
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--gold);
      margin: 8px 0;
    }
    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .small {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--brown-dark);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .profile-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 12px;
  min-width: 200px;
  display: none;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  z-index: 1000;
}

.profile-menu.open {
  display: block;
}
    .profile-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--brown);
      transition: background 0.2s;
    }
    .profile-menu-item:last-child {
      border-bottom: none;
    }
    .profile-menu-item:hover {
      background: var(--brown);
    }
    .otp-input {
      text-align: center;
      font-size: 1.5rem;
      letter-spacing: 8px;
    }
    @media (max-width: 768px) {
      .menu-grid {
        grid-template-columns: 1fr;
      }
      .cart-panel {
        max-width: 100%;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="header">
    <div class="brand">
      <h1>ğŸ› ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©</h1>
    </div>
    <div class="header-actions">
      <div style="position: relative;">
        <button class="profile-btn" id="profileBtn">
          ğŸ‘¤
          <span class="order-badge" id="orderBadge" style="display: none;">0</span>
        </button>
        <div class="profile-menu" id="profileMenu">
          <div class="profile-menu-item" id="trackOrdersBtn">ğŸ“¦ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</div>
        </div>
      </div>
    </div>
  </div>

  <div class="categories-section">
    <div class="categories-scroll" id="categoriesScroll"></div>
  </div>

  <div class="customer-status" id="customerStatus">
    <h3 style="color: var(--gold); margin-top: 0;">Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙƒ</h3>
    <div id="statusContent"></div>
  </div>

  <div class="container">
    <div class="menu-container" id="menuContainer"></div>
  </div>

  <button class="cart-toggle" id="cartToggle">
    ğŸ›’
    <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
  </button>

  <div class="cart-panel" id="cartPanel">
    <div class="cart-header">
      <div class="cart-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
      <button class="close-cart" id="closeCart">Ã—</button>
    </div>
    <div class="small" id="cartCustomerInfo">Ø¶ÙŠÙ â€” Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯</div>
    <div class="cart-items" id="cartItems">
      <div class="small" style="text-align: center; padding: 20px; color: var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
    </div>
    <div style="margin: 16px 0;">
      <label class="small">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <select id="applyOffer" class="input"></select>
    </div>
    <div class="cart-total" id="cartTotal">0 Ø¬</div>
    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
      <button class="btn btn-primary" id="checkoutBtn" style="flex: 1;">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn btn-secondary" id="clearCartBtn">ØªÙØ±ÙŠØº</button>
    </div>
    <div class="small" style="text-align: center;">Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</div>
  </div>

  <div class="cart-panel" id="ordersPanel">
    <div class="cart-header">
      <div class="cart-title">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ</div>
      <button class="close-cart" id="closeOrders">Ã—</button>
    </div>
    <div id="myOrdersList"></div>
  </div>

  <div class="checkout-section" id="checkoutSection">
    <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØ§Ù„Ø¯ÙØ¹</div>
    <input id="orderName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />
    <input id="orderAddress" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ØªÙØµÙŠÙ„)" />
    <select id="orderPayment" class="input">
      <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
      <option value="vodafone">ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
    </select>
    <textarea id="orderNotes" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    <input id="orderPhone" class="input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
    <div style="display: flex; gap: 8px; margin-top: 16px;">
      <button class="btn btn-primary" id="confirmOrderBtn" style="flex: 1;">Ù…ØªØ§Ø¨Ø¹Ø©</button>
      <button class="btn btn-secondary" id="cancelCheckoutBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <div class="modal" id="otpModal">
    <div class="modal-content">
      <div class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
      <p class="small" style="text-align: center; margin-bottom: 16px;">
        Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø±Ù‚Ù… <span id="otpPhoneDisplay"></span>
      </p>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <button class="btn btn-primary" id="sendOtpBtn" style="flex: 1;">Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
        <button class="btn btn-secondary" id="skipOtpBtn">ØªØ®Ø·ÙŠ</button>
      </div>
      <div id="otpInputSection" style="display: none;">
        <p class="small" style="text-align: center; margin-bottom: 12px;">
          ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ. Ø³ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        </p>
        <input id="otpCode" class="input otp-input" placeholder="000000" maxlength="6" autocomplete="one-time-code" />
        <button class="btn btn-primary" id="verifyOtpBtn" style="width: 100%; margin-top: 12px;">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
        <button class="btn btn-secondary" id="resendOtpBtn" style="width: 100%; margin-top: 8px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <div class="modal" id="cancelModal">
    <div class="modal-content">
      <div class="modal-title">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</div>
      <p class="small" style="margin-bottom: 16px;">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:</p>
      <textarea id="cancelReason" class="input" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡"></textarea>
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn btn-danger" id="confirmCancelBtn" style="flex: 1;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-secondary" id="closeCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div class="operator-dashboard" id="operatorDashboard">
    <div style="padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: var(--gold);">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´ØºÙ„</h2>
        <button class="btn btn-danger" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="orders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="tab" data-tab="history">Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</button>
        <button class="tab" data-tab="epot">EPOT</button>
      </div>
      <div class="tab-content active" id="ordersContent">
        <div class="search-bar">
          <input class="input" id="searchOrderAddress" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
          <input class="input" id="searchOrderPhone" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <input class="input" id="searchOrderId" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ†" />
          <input class="input" id="searchOrderName" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <button class="btn btn-primary" id="searchOrderBtn">Ø¨Ø­Ø«</button>
        </div>
        <div id="ordersGrid"></div>
      </div>
      <div class="tab-content" id="historyContent">
        <div class="section-title">Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="search-bar">
          <input class="input" id="searchAddress" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
          <input class="input" id="searchPhone" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <input class="input" id="searchOrderIdHist" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ†" />
          <input class="input" id="searchName" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <button class="btn btn-primary" id="searchBtn">Ø¨Ø­Ø«</button>
        </div>
        <div id="historyGrid"></div>
      </div>
      <div class="tab-content" id="epotContent">
  <div id="epotLocked">
    <div class="section-title">EPOT â€” Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</div>
    <p class="small">Ù…Ù‚ÙÙˆÙ„ â€” Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ø¶ØºØ· ÙØªØ­ EPOT ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
    <button class="btn btn-primary" id="openEpotBtn">ÙØªØ­ EPOT</button>
  </div>
  <div id="epotUnlocked" style="display: none;">
    <div class="section-title">EPOT</div>
    <button class="btn btn-secondary" id="lockEpotBtn" style="margin-bottom: 16px;">Ù‚ÙÙ„ EPOT</button>
    
    <div class="checkbox-container">
      <input type="checkbox" id="autoPrintCheckbox" />
      <label for="autoPrintCheckbox">Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</label>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        <div class="stat-value" id="totalRevenue">0 Ø¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="stat-value" id="todayOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="stat-value" id="todayRevenue">0 Ø¬</div>
      </div>
    </div>
    
    <button class="btn btn-danger" id="endDayBtn" style="width: 100%; margin-bottom: 20px;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</button>
    
    <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¯Ø§Ø®Ù„ EPOT -->
    <div style="margin-bottom: 30px;">
      <div class="section-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (EPOT)</div>
      <div class="search-bar">
        <input class="input" id="searchEpotAddress" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" />
        <input class="input" id="searchEpotPhone" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
        <input class="input" id="searchEpotOrderId" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ†" />
        <input class="input" id="searchEpotName" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
        <button class="btn btn-primary" id="searchEpotBtn">Ø¨Ø­Ø«</button>
      </div>
      <div id="epotHistoryGrid"></div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--gold);">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT</h3>
      <div style="display: flex; gap: 8px;">
        <input id="newEpotPwd" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" />
        <button class="btn btn-primary" id="setEpotPwdBtn">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--gold);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
      <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
        <input id="newItemName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" style="flex: 1; min-width: 150px;" />
        <input id="newItemPrice" class="input" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="width: 100px;" />
        <select id="newItemCategory" class="input" style="width: 150px;"></select>
        <button class="btn btn-primary" id="addItemBtn">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
      </div>
      <div id="manageItemsList"></div>
    </div>
    
    <div>
      <h3 style="color: var(--gold);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶</h3>
      <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
        <input id="offerName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" style="flex: 1; min-width: 150px;" />
        <input id="offerDiscount" class="input" type="number" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %" style="width: 100px;" />
        <button class="btn btn-primary" id="createOfferBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶</button>
      </div>
      <div id="offersList"></div>
    </div>
    
    <button class="btn btn-secondary" id="exportDataBtn" style="width: 100%; margin-top: 20px;">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>
</div>
    </div>
  </div>

  <div class="modal" id="epotModal">
    <div class="modal-content">
      <div class="modal-title">ÙØªØ­ EPOT</div>
      <input id="epotPassword" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± EPOT" />
      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button class="btn btn-primary" id="submitEpotBtn" style="flex: 1;">ÙØªØ­</button>
        <button class="btn btn-secondary" id="cancelEpotBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDdK_slp4ysFLYHknvwgpmqfcWQszB1rxs",
      authDomain: "koshary-abosamra.firebaseapp.com",
      databaseURL: "https://koshary-abosamra-default-rtdb.firebaseio.com",
      projectId: "koshary-abosamra",
      storageBucket: "koshary-abosamra.firebasestorage.app",
      messagingSenderId: "803911056967",
      appId: "1:803911056967:web:da1d8533ffe6c0fbc53b62",
      measurementId: "G-2TVX0F48Y8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const LS_KEYS = {
      MENU: 'tk_menu_v1',
      ORDERS: 'tk_orders_v1',
      HISTORY: 'tk_history_v1',
      OFFERS: 'tk_offers_v1',
      OP_PWD: 'tk_op_pwd_v1',
      EPOT_PWD: 'tk_epot_pwd_v1',
      CUST: 'tk_cust_v1',
      RECEIPT_COUNTER: 'tk_receipt_v1',
      AUTO_PRINT: 'tk_auto_print_v1',
      USER_ACCOUNT: 'tk_user_account_v1',
      USER_ORDERS: 'tk_user_orders_v1'
    };

    const DEFAULT_MENU = {
      "Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'k-mini', name: 'Ø¹Ù„Ø¨Ø© Ù…ÙŠÙ†ÙŠ', price: 17, available: true, sold: 0 },
        { id: 'k-large', name: 'Ø¹Ù„Ø¨Ø© Ù„Ø§Ø±Ø¬', price: 20, available: true, sold: 0 },
        { id: 'k-shaqia', name: 'Ø¹Ù„Ø¨Ø© Ø´Ù‚ÙŠØ©', price: 25, available: true, sold: 0 },
        { id: 'k-mftria', name: 'Ø¹Ù„Ø¨Ù‡ Ù…ÙØªØ±ÙŠØ©', price: 30, available: true, sold: 0 },
        { id: 'k-abo', name: 'Ø¹Ù„Ø¨Ø© Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©', price: 35, available: true, sold: 0 },
        { id: 'k-triple', name: 'Ø¹Ù„Ø¨Ø© ØªØ±ÙŠØ¨Ù„', price: 40, available: true, sold: 0 }
      ],
      "Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙƒØ´Ø±ÙŠ": [
        { id: 'add-tqliya', name: 'ØªÙ‚Ù„ÙŠÙ‡', price: 9, available: true, sold: 0 },
        { id: 'add-salsa', name: 'ØµÙ„ØµØ©', price: 6, available: true, sold: 0 },
        { id: 'add-dokka', name: 'Ø¯Ù‚Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-shata', name: 'Ø´Ø·Ø©', price: 4, available: true, sold: 0 },
        { id: 'add-ads', name: 'Ø¹Ø¯Ø³', price: 6, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©": [
        { id: 'side-qaramisho', name: 'Ù‚Ø±Ø§Ù…ÙŠØ´Ùˆ (ØªÙˆØ³Øª)', price: 9, available: true, sold: 0 },
        { id: 'side-mkhlal', name: 'Ù…Ø®Ù„Ù„ Ù…Ø´ÙƒÙ„', price: 8, available: true, sold: 0 },
        { id: 'side-slt-kh', name: 'Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡', price: 8, available: true, sold: 0 },
        { id: 'side-khyar', name: 'Ø®ÙŠØ§Ø± Ù…ØªØ¨Ù„', price: 8, available: true, sold: 0 },
        { id: 'side-tmatem', name: 'Ø·Ù…Ø§Ø·Ù… Ù…ØªØ¨Ù„Ù‡', price: 8, available: true, sold: 0 }
      ],
      "Ø§Ù„Ø·ÙˆØ§Ø¬Ù†": [
        { id: 't-mkr', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø©', price: 27, available: true, sold: 0 },
        { id: 't-mkr-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 45, available: true, sold: 0 },
        { id: 't-mkr-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 47, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙŠÙƒØ³": [
        { id: 'mix-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø³Ø§Ø¯Ø©', price: 47, available: true, sold: 0 },
        { id: 'mix-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ù„Ø­Ù…Ø©', price: 65, available: true, sold: 0 },
        { id: 'mix-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬', price: 65, available: true, sold: 0 }
      ],
      "Ø·ÙˆØ§Ø¬Ù† Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§": [
        { id: 'moz-sada', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 47, available: true, sold: 0 },
        { id: 'moz-lhm', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ù„Ø­Ù…Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 },
        { id: 'moz-dj', name: 'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ù„Ø¯Ø¬Ø§Ø¬ Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§', price: 65, available: true, sold: 0 }
      ],
      "Ø­Ù„Ùˆ Ø£Ø¨ÙˆØ³Ù…Ø±Ø©": [
        { id: 'hlb-kebir', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙƒØ¨ÙŠØ±', price: 18, available: true, sold: 0 },
        { id: 'hlb-forn', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙØ±Ù†', price: 20, available: true, sold: 0 },
        { id: 'hlb-koshry', name: 'ÙƒØ´Ø±ÙŠ Ø§Ù„Ø­Ù„Ùˆ', price: 22, available: true, sold: 0 },
        { id: 'hlb-qar3', name: 'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¹', price: 25, available: true, sold: 0 }
      ],
      "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [
        { id: 'water-s', name: 'Ù…ÙŠØ§Ù‡ ØµØºÙŠØ±Ø©', price: 6, available: true, sold: 0 },
        { id: 'water-l', name: 'Ù…ÙŠØ§Ù‡ ÙƒØ¨ÙŠØ±Ø©', price: 10, available: true, sold: 0 },
        { id: 'pepsi', name: 'Ø¨Ø¨ÙŠØ¬ ÙƒÙˆÙ„Ø§', price: 18, available: true, sold: 0 },
        { id: 'slsh-tot', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ ØªÙˆØª', price: 10, available: true, sold: 0 },
        { id: 'slsh-lmna', name: 'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ (Ù„ÙŠÙ…ÙˆÙ† â€“ Ù†Ø¹Ù†Ø§Ø¹)', price: 18, available: true, sold: 0 }
      ]
    };

    let menu = loadLS(LS_KEYS.MENU, DEFAULT_MENU);
    let orders = loadLS(LS_KEYS.ORDERS, []);
    let orderHistory = loadLS(LS_KEYS.HISTORY, []);
    let offers = loadLS(LS_KEYS.OFFERS, []);
    let cart = [];
    let currentCustomer = loadLS(LS_KEYS.CUST, null);
    let userAccount = loadLS(LS_KEYS.USER_ACCOUNT, null);
    let userOrders = loadLS(LS_KEYS.USER_ORDERS, []);
    let receiptCounter = Number(localStorage.getItem(LS_KEYS.RECEIPT_COUNTER) || 1);
    let operatorPassword = localStorage.getItem(LS_KEYS.OP_PWD) || 'admin123';
    let epotPassword = localStorage.getItem(LS_KEYS.EPOT_PWD) || 'epot123';
    let isOperatorAuth = false;
    let isEpotAuth = false;
    let currentView = 'customer';
    let secretCode = '';
    let autoPrint = localStorage.getItem(LS_KEYS.AUTO_PRINT) === 'true';
    let pendingOrderData = null;
    let generatedOtp = null;
    let orderToCancel = null;

    function saveLS(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function loadLS(key, fallback) { 
      try { 
        const r = localStorage.getItem(key); 
        return r ? JSON.parse(r) : fallback; 
      } catch (e) { 
        return fallback; 
      } 
    }
    function generateId(prefix = 'ID') { 
      return prefix + '-' + Date.now().toString(36) + '-' + Math.floor(Math.random() * 900).toString(36); 
    }
    function saveState() {
      saveLS(LS_KEYS.MENU, menu);
      saveLS(LS_KEYS.ORDERS, orders);
      saveLS(LS_KEYS.HISTORY, orderHistory);
      saveLS(LS_KEYS.OFFERS, offers);
      saveLS(LS_KEYS.CUST, currentCustomer);
      saveLS(LS_KEYS.USER_ACCOUNT, userAccount);
      saveLS(LS_KEYS.USER_ORDERS, userOrders);
      localStorage.setItem(LS_KEYS.RECEIPT_COUNTER, String(receiptCounter));
      localStorage.setItem(LS_KEYS.AUTO_PRINT, String(autoPrint));
    }
    function notify(msg, type = 'info') {
      const notif = document.getElementById('notification');
      notif.textContent = msg;
      notif.className = 'notification';
      if (type === 'error') notif.classList.add('error');
      if (type === 'warning') notif.classList.add('warning');
      notif.style.display = 'block';
      setTimeout(() => notif.style.display = 'none', 3000);
    }
    function findItemById(id) {
      for (const cat in menu) {
        const item = menu[cat].find(i => i.id === id);
        if (item) return item;
      }
      return null;
    }

    window.onload = function() {
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const savedView = sessionStorage.getItem('currentView');
  const savedEpotAuth = sessionStorage.getItem('isEpotAuth') === 'true';
  const savedOperatorAuth = sessionStorage.getItem('isOperatorAuth') === 'true';
  
  syncFromFirebase();
  renderCategories();
  renderMenu();
  renderOffers();
  updateCartDisplay();
  setupEventListeners();
  updateUserInfo();
  document.getElementById('autoPrintCheckbox').checked = autoPrint;
  
  if ('OTPCredential' in window) {
    setupWebOTP();
  }
  
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  if (savedOperatorAuth) {
    isOperatorAuth = true;
    showOperatorView();
    if (savedEpotAuth) {
      isEpotAuth = true;
      showEpotPanel();
    }
  }
};

    function setupWebOTP() {
      const otpInput = document.getElementById('otpCode');
      if (otpInput && 'OTPCredential' in window) {
        const ac = new AbortController();
        navigator.credentials.get({
          otp: { transport: ['sms'] },
          signal: ac.signal
        }).then(otp => {
          otpInput.value = otp.code;
          verifyOtp();
        }).catch(err => {
          console.log('WebOTP error:', err);
        });
      }
    }

    function updateUserInfo() {
      const info = document.getElementById('cartCustomerInfo');
      if (userAccount) {
        info.textContent = `ğŸ‘¤ ${userAccount.name} â€” ${userAccount.phone}`;
        const activeOrders = userOrders.filter(o => o.status !== 'delivered' && !o.cancelled).length;
        document.getElementById('orderBadge').style.display = activeOrders > 0 ? 'flex' : 'none';
        document.getElementById('orderBadge').textContent = activeOrders;
      } else {
        info.textContent = 'Ø¶ÙŠÙ â€” Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯';
        document.getElementById('orderBadge').style.display = 'none';
      }
    }

    function syncFromFirebase() {
  database.ref('menu').on('value', (snapshot) => {
    if (snapshot.val()) {
      menu = snapshot.val();
      saveLS(LS_KEYS.MENU, menu);
      renderMenu();
      renderCategories();
      if (isEpotAuth) renderItemManagement();
    }
  });

  database.ref('offers').on('value', (snapshot) => {
    offers = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.OFFERS, offers);
    renderOffers();
  });

  database.ref('orders').on('value', (snapshot) => {
    orders = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.ORDERS, orders);
    if (currentView === 'operator') {
      renderOrders();
      updateOperatorBadge();
    }
    checkCustomerOrders();
    syncUserOrders();
    
    const ordersPanel = document.getElementById('ordersPanel');
    if (ordersPanel && ordersPanel.classList.contains('open')) {
      showMyOrders();
    }
  });

  database.ref('history').on('value', (snapshot) => {
    orderHistory = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.HISTORY, orderHistory);
    if (currentView === 'operator') {
      renderHistory();
      if (isEpotAuth) {
        renderEpotHistory();
        updateStats();
      }
    }
    syncUserOrders();
  });
}

  database.ref('offers').on('value', (snapshot) => {
    offers = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.OFFERS, offers);
    renderOffers();
  });

  database.ref('orders').on('value', (snapshot) => {
    orders = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.ORDERS, orders);
    if (currentView === 'operator') {
      renderOrders();
      updateOperatorBadge();
    }
    checkCustomerOrders();
    syncUserOrders();
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø·Ù„Ø¨Ø§ØªÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
    const ordersPanel = document.getElementById('ordersPanel');
    if (ordersPanel && ordersPanel.classList.contains('open')) {
      showMyOrders();
    }
  });

  database.ref('history').on('value', (snapshot) => {
    orderHistory = snapshot.val() ? Object.values(snapshot.val()) : [];
    saveLS(LS_KEYS.HISTORY, orderHistory);
    if (currentView === 'operator') {
      renderHistory();
      if (isEpotAuth) {
        renderEpotHistory();
        updateStats();
      }
    }
    syncUserOrders();
  });
}

// ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­ÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
database.ref('orders').on('child_changed', (snapshot) => {
  const updatedOrder = snapshot.val();
  if (updatedOrder && userAccount && updatedOrder.customerPhone === userAccount.phone) {
    const idx = userOrders.findIndex(o => o.id === updatedOrder.id);
    if (idx !== -1) {
      userOrders[idx] = updatedOrder;
      saveLS(LS_KEYS.USER_ORDERS, userOrders);
      checkCustomerOrders();
      showMyOrders();
    }
  }
});
      database.ref('history').on('value', (snapshot) => {
        if (snapshot.val()) {
          orderHistory = Object.values(snapshot.val());
          saveLS(LS_KEYS.HISTORY, orderHistory);
          renderHistory();
          syncUserOrders();
        }
      });
    }

    function syncUserOrders() {
  const customerPhone = userAccount?.phone || currentCustomer?.phone;
  if (!customerPhone) {
    userOrders = [];
    saveLS(LS_KEYS.USER_ORDERS, userOrders);
    updateUserInfo();
    return;
  }

  // Ø¯Ù…Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„ØªØ§Ø±ÙŠØ® (Ù„Ø£Ù†Ù‡ Ø§Ù„Ø£Ø­Ø¯Ø«)
  const ordersMap = new Map();
  
  // Ø£Ø¶Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
  orders.forEach(o => {
    if (o.customerPhone === customerPhone) {
      ordersMap.set(o.id, o);
    }
  });
  
  // Ø£Ø¶Ù/Ø­Ø¯Ø« Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØ³ØªØ¨Ø¯Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
  orderHistory.forEach(o => {
    if (o.customerPhone === customerPhone) {
      ordersMap.set(o.id, o);
    }
  });
  
  userOrders = Array.from(ordersMap.values());
  saveLS(LS_KEYS.USER_ORDERS, userOrders);
  updateUserInfo();
}

function renderEpotHistory(filtered = null) {
  const grid = document.getElementById('epotHistoryGrid');
  if (!grid) return;

  const historyToShow = filtered || orderHistory;

  grid.innerHTML = '';
  if (historyToShow.length === 0) {
    grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
    return;
  }

  historyToShow.forEach(order => {
    const card = document.createElement('div');
    card.className = 'order-card';
    if (order.cancelled) card.classList.add('cancelled');
    
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
          ${order.cancelled ? '<span class="badge badge-cancelled">Ù…Ù„ØºÙŠ</span>' : '<span class="badge badge-delivered">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>'}
          <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
          <div class="small">${order.createdAt}</div>
        </div>
        <div style="font-weight: bold; color: var(--gold);">${order.total} Ø¬</div>
      </div>
      <div class="order-details" id="epot-hist-${order.id}">
        <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
          <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
          <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
          ${order.cancelled && order.cancelReason ? `<div style="color: var(--danger);"><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:</strong> ${order.cancelReason}</div>` : ''}
          ${!order.cancelled && order.items && order.items.length > 0 ? `
            <div style="margin-top: 12px;">
              ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
    card.onclick = () => {
      const details = document.getElementById(`epot-hist-${order.id}`);
      details.classList.toggle('open');
    };
    grid.appendChild(card);
  });
}

function searchEpotHistory() {
  const address = document.getElementById('searchEpotAddress').value.trim().toLowerCase();
  const phone = document.getElementById('searchEpotPhone').value.trim();
  const orderId = document.getElementById('searchEpotOrderId').value.trim();
  const name = document.getElementById('searchEpotName').value.trim().toLowerCase();

  const filtered = orderHistory.filter(o => {
    if (address && !o.customer.address.toLowerCase().includes(address)) return false;
    if (phone && !o.customer.phone.includes(phone)) return false;
    if (orderId && !String(o.receiptNo).includes(orderId)) return false;
    if (name && !o.customer.name.toLowerCase().includes(name)) return false;
    return true;
  });

  renderEpotHistory(filtered);
}

    function renderCategories() {
      const container = document.getElementById('categoriesScroll');
      container.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = cat;
        btn.onclick = () => scrollToCategory(cat);
        container.appendChild(btn);
      });
    }

    function scrollToCategory(cat) {
      const section = document.getElementById(`section-${cat}`);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
      }
    }

    function renderMenu() {
      const container = document.getElementById('menuContainer');
      container.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const section = document.createElement('div');
        section.className = 'menu-section';
        section.id = `section-${cat}`;
        section.innerHTML = `<div class="section-title">${cat}</div><div class="menu-grid" id="grid-${cat}"></div>`;
        container.appendChild(section);
        const grid = section.querySelector('.menu-grid');
        menu[cat].forEach(item => {
          const card = document.createElement('div');
          card.className = 'menu-item';
          card.innerHTML = `
            <h4>${item.name}</h4>
            <div class="price">${item.price} Ø¬</div>
            ${!item.available ? '<div class="small" style="color: #f97316;">ØºÙŠØ± Ù…ØªÙˆÙØ±</div>' : ''}
            <button class="add-cart-btn" ${!item.available ? 'disabled' : ''}>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
          `;
          card.querySelector('button').onclick = () => addToCart(item.id);
          grid.appendChild(card);
        });
      });
    }

    function addToCart(itemId) {
      const item = findItemById(itemId);
      if (!item || !item.available) {
        notify('Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
        return;
      }
      const existing = cart.find(c => c.id === item.id);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ id: item.id, name: item.name, price: item.price, qty: 1 });
      }
      updateCartDisplay();
      notify(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${item.name}`, 'info');
      document.getElementById('cartPanel').classList.add('open');
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const cartBadge = document.getElementById('cartBadge');
      const cartTotal = document.getElementById('cartTotal');
      
      if (cart.length === 0) {
        cartItems.innerHTML = '<div class="small" style="text-align: center; padding: 20px; color: var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
        cartBadge.style.display = 'none';
        cartTotal.textContent = '0 Ø¬';
        return;
      }

      cartBadge.style.display = 'flex';
      cartBadge.textContent = cart.reduce((sum, c) => sum + c.qty, 0);

      cartItems.innerHTML = '';
      let total = 0;
      cart.forEach((item, idx) => {
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div>
            <strong>${item.name}</strong>
            <div class="small">${item.qty} Ã— ${item.price} Ø¬</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-end;">
            <div style="font-weight: bold; color: var(--gold);">${itemTotal} Ø¬</div>
            <div style="display: flex; gap: 6px;">
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.9rem;" onclick="decreaseQty(${idx})">-</button>
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.9rem;" onclick="increaseQty(${idx})">+</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.9rem;" onclick="removeFromCart(${idx})">Ã—</button>
            </div>
          </div>
        `;
        cartItems.appendChild(div);
      });

      const offerId = document.getElementById('applyOffer').value;
      if (offerId) {
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
          total = Math.round(total * (1 - offer.discount / 100));
        }
      }

      cartTotal.textContent = `${total} Ø¬`;
    }

    window.increaseQty = function(idx) {
      cart[idx].qty++;
      updateCartDisplay();
    };

    window.decreaseQty = function(idx) {
      if (cart[idx].qty > 1) {
        cart[idx].qty--;
      } else {
        cart.splice(idx, 1);
      }
      updateCartDisplay();
    };

    window.removeFromCart = function(idx) {
      cart.splice(idx, 1);
      updateCartDisplay();
    };

    function openCheckout() {
      if (cart.length === 0) {
        notify('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©', 'warning');
        return;
      }
      document.getElementById('cartPanel').classList.remove('open');
      const section = document.getElementById('checkoutSection');
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth' });
      
      if (userAccount) {
        document.getElementById('orderName').value = userAccount.name || '';
        document.getElementById('orderPhone').value = userAccount.phone || '';
        document.getElementById('orderAddress').value = userAccount.address || '';
        document.getElementById('orderNotes').value = userAccount.notes || '';
      } else if (currentCustomer) {
        document.getElementById('orderName').value = currentCustomer.name || '';
        document.getElementById('orderPhone').value = currentCustomer.phone || '';
      }
    }

    function confirmOrder() {
      const name = document.getElementById('orderName').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const address = document.getElementById('orderAddress').value.trim();
      const payment = document.getElementById('orderPayment').value;
      const notes = document.getElementById('orderNotes').value.trim();

      if (!name || !phone || !address) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
        return;
      }

      if (phone.length < 10) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­', 'warning');
        return;
      }

      pendingOrderData = {
        name,
        phone,
        address,
        payment,
        notes
      };

      if (userAccount && userAccount.phone === phone) {
        processOrder(false);
      } else {
        document.getElementById('otpPhoneDisplay').textContent = phone;
        document.getElementById('otpModal').classList.add('open');
        document.getElementById('otpInputSection').style.display = 'none';
      }
    }

    function sendOtp() {
      const phone = pendingOrderData.phone;
      generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
      
      console.log('OTP Code:', generatedOtp, 'for phone:', phone);
      
      setTimeout(() => {
        notify('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ù‡Ø§ØªÙÙƒ', 'info');
      }, 500);

      document.getElementById('otpInputSection').style.display = 'block';
      setupWebOTP();
    }

    function verifyOtp() {
      const enteredOtp = document.getElementById('otpCode').value.trim();
      
      if (enteredOtp === generatedOtp) {
        userAccount = {
          phone: pendingOrderData.phone,
          name: pendingOrderData.name,
          address: pendingOrderData.address,
          notes: pendingOrderData.notes,
          createdAt: new Date().toISOString()
        };
        
        saveState();
        updateUserInfo();
        
        document.getElementById('otpModal').classList.remove('open');
        document.getElementById('otpCode').value = '';
        
        processOrder(true);
      } else {
        notify('ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
      }
    }

    function processOrder(isNewAccount) {
  currentCustomer = { 
    name: pendingOrderData.name, 
    phone: pendingOrderData.phone 
  };
  saveLS(LS_KEYS.CUST, currentCustomer);

  const receiptNo = receiptCounter++;
  localStorage.setItem(LS_KEYS.RECEIPT_COUNTER, String(receiptCounter));

  const orderId = generateId('ORD');
  let total = cart.reduce((s, c) => s + c.price * c.qty, 0);
  const totalBefore = total;
  let appliedOffer = null;

  const offerId = document.getElementById('applyOffer').value;
  if (offerId) {
    const offer = offers.find(o => o.id === offerId);
    if (offer) {
      appliedOffer = { id: offer.id, name: offer.name, discount: offer.discount };
      total = Math.round(total * (1 - offer.discount / 100));
    }
  }

  const newOrder = {
    id: orderId,
    receiptNo,
    customer: { 
      name: pendingOrderData.name, 
      phone: pendingOrderData.phone, 
      address: pendingOrderData.address 
    },
    items: cart.map(c => ({ id: c.id, name: c.name, price: c.price, qty: c.qty })),
    totalBefore,
    total,
    payment: pendingOrderData.payment,
    notes: pendingOrderData.notes,
    appliedOffer,
    status: 'received',
    createdAt: new Date().toLocaleString('ar-EG'),
    date: new Date().toDateString(),
    customerPhone: pendingOrderData.phone,
    cancelled: false,
    cancelReason: null
  };

  cart.forEach(c => {
    const item = findItemById(c.id);
    if (item) item.sold = (item.sold || 0) + c.qty;
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Firebase ÙÙ‚Ø· - Ù„Ø§ Ù†Ø¶ÙŠÙ Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  database.ref('orders/' + orderId).set(newOrder);
  database.ref('menu').set(menu);

  if (autoPrint) {
    printReceipt(newOrder);
  }

  cart = [];
  updateCartDisplay();
  document.getElementById('checkoutSection').style.display = 'none';
  
  if (isNewAccount) {
    notify(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… ${receiptNo}`, 'info');
  } else {
    notify(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ø±Ù‚Ù… ${receiptNo}`, 'info');
  }
  
  document.getElementById('orderAddress').value = '';
  document.getElementById('orderNotes').value = '';
  
  pendingOrderData = null;
  generatedOtp = null;
  
  updateUserInfo();
}

        function printReceipt(order) {
      const printWindow = window.open('', '', 'width=380,height=600');
      let itemsHtml = '';
      order.items.forEach(i => {
        itemsHtml += `<div class="item"><span>${i.name} Ã— ${i.qty}</span><span>${i.price * i.qty} Ø¬</span></div>`;
      });

      printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
          <meta charset="utf-8">
          <title>Ø¨ÙˆÙ† #${order.receiptNo}</title>
          <style>
            body { font-family: Arial, Helvetica, sans-serif; padding: 15px; font-size: 16px; line-height: 1.5; }
            h2 { text-align: center; margin: 0 0 10px; font-size: 22px; }
            .line { border-bottom: 2px dashed #000; margin: 15px 0; }
            .item { display: flex; justify-content: space-between; margin: 8px 0; }
            .total { font-weight: bold; font-size: 20px; text-align: center; margin: 20px 0 10px; }
            .center { text-align: center; }
          </style>
        </head>
        <body>
          <h2>ğŸ› ÙƒØ´Ø±ÙŠ Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©</h2>
          <div class="center">Ø¨ÙˆÙ† Ø±Ù‚Ù…: ${order.receiptNo}</div>
          <div class="line"></div>
          <div>Ø§Ù„Ø§Ø³Ù…: ${order.customer.name}</div>
          <div>Ø§Ù„Ù‡Ø§ØªÙ: ${order.customer.phone}</div>
          <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${order.customer.address}</div>
          <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${order.createdAt}</div>
          <div class="line"></div>
          ${itemsHtml}
          <div class="line"></div>
          ${order.appliedOffer ? `<div>ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶: ${order.appliedOffer.name}</div>` : ''}
          <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total} Ø¬Ù†ÙŠÙ‡</div>
          <div>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${order.payment === 'cash' ? 'ÙƒØ§Ø´' : 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'}</div>
          ${order.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes}</div>` : ''}
          <div class="center" style="margin-top: 30px; font-size: 14px; color: #555;">
            Ø´ÙƒØ±Ù‹Ø§ Ù„Ø«Ù‚ØªÙƒÙ… ğŸ› Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø© Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => printWindow.print(), 500);
    }

    function checkCustomerOrders() {
  const customerPhone = userAccount?.phone || currentCustomer?.phone;
  
  if (!customerPhone) return;
  
  const allUserOrders = [...orders, ...orderHistory].filter(o => o.customerPhone === customerPhone);
  
  const activeOrders = allUserOrders.filter(o => 
    o.status !== 'delivered' && 
    !o.cancelled
  );

  const statusDiv = document.getElementById('customerStatus');
  const statusContent = document.getElementById('statusContent');

  if (activeOrders.length > 0) {
    statusDiv.classList.add('show');
    statusContent.innerHTML = '';
    activeOrders.forEach(order => {
      const statusText = {
        'received': 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',
        'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
        'ready': 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…'
      };
      const statusClass = {
        'received': 'badge-received',
        'preparing': 'badge-preparing',
        'ready': 'badge-ready'
      };
      
      const statuses = ['received', 'preparing', 'ready', 'delivered'];
      const currentStatusIndex = statuses.indexOf(order.status) || 0;
      
      let progressHTML = '<div style="margin: 8px 0; background: var(--brown-dark); border-radius: 8px; overflow: hidden; display: flex;">';
      statuses.slice(0, 3).forEach((status, idx) => {
        const isCompleted = idx <= currentStatusIndex;
        const bgColor = isCompleted ? 'var(--gold)' : 'var(--brown)';
        progressHTML += '<div style="flex: 1; text-align: center; padding: 6px; background: ' + bgColor + '; color: #1a1410; font-size: 0.75rem; font-weight: bold;">' + statusText[status] + '</div>';
      });
      progressHTML += '</div>';
      
      const div = document.createElement('div');
      div.style.marginBottom = '12px';
      div.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><strong>Ø·Ù„Ø¨ Ø±Ù‚Ù…: ' + order.receiptNo + '</strong><span class="badge ' + statusClass[order.status] + '">' + statusText[order.status] + '</span></div>' + progressHTML + '<div class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + order.total + ' Ø¬</div>';
      statusContent.appendChild(div);
    });
  } else {
    statusDiv.classList.remove('show');
  }
}

    function showMyOrders() {
  const panel = document.getElementById('ordersPanel');
  const list = document.getElementById('myOrdersList');
  
  list.innerHTML = '';
  
  const customerPhone = userAccount?.phone || currentCustomer?.phone;
  
  if (!customerPhone) {
    list.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„!</div>';
    panel.classList.add('open');
    return;
  }

  const allUserOrders = [...orders, ...orderHistory].filter(o => o.customerPhone === customerPhone);

  if (allUserOrders.length === 0) {
    list.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£ÙˆÙ„!</div>';
    panel.classList.add('open');
    return;
  }

  const currentOrders = allUserOrders.filter(o => !o.cancelled && o.status !== 'delivered');
  const deliveredOrders = allUserOrders.filter(o => o.status === 'delivered' && !o.cancelled);
  const cancelledOrders = allUserOrders.filter(o => o.cancelled);

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…ÙØªÙˆØ­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹)
  if (currentOrders.length > 0) {
    const section = document.createElement('div');
    section.innerHTML = '<h3 style="color: var(--gold); margin-bottom: 12px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (' + currentOrders.length + ')</h3>';
    
    currentOrders.forEach(order => {
      const card = createOrderCard(order, true);
      section.appendChild(card);
    });
    
    list.appendChild(section);
  }

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ)
  if (deliveredOrders.length > 0) {
    const section = document.createElement('div');
    section.style.marginTop = '20px';
    
    const header = document.createElement('div');
    header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; background: var(--brown); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 12px;';
    header.innerHTML = '<h3 style="color: var(--gold); margin: 0;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (' + deliveredOrders.length + ')</h3><span style="font-size: 1.5rem; color: var(--gold);" id="delivered-arrow">â–¼</span>';
    
    const content = document.createElement('div');
    content.id = 'delivered-content';
    content.style.display = 'none';
    
    deliveredOrders.forEach(order => {
      const card = createOrderCard(order, false);
      content.appendChild(card);
    });
    
    header.onclick = () => {
      const arrow = document.getElementById('delivered-arrow');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
      } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
      }
    };
    
    section.appendChild(header);
    section.appendChild(content);
    list.appendChild(section);
  }

  // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ)
  if (cancelledOrders.length > 0) {
    const section = document.createElement('div');
    section.style.marginTop = '20px';
    
    const header = document.createElement('div');
    header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; background: var(--brown); padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 12px;';
    header.innerHTML = '<h3 style="color: var(--danger); margin: 0;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø© (' + cancelledOrders.length + ')</h3><span style="font-size: 1.5rem; color: var(--danger);" id="cancelled-arrow">â–¼</span>';
    
    const content = document.createElement('div');
    content.id = 'cancelled-content';
    content.style.display = 'none';
    
    cancelledOrders.forEach(order => {
      const card = createOrderCard(order, false);
      content.appendChild(card);
    });
    
    header.onclick = () => {
      const arrow = document.getElementById('cancelled-arrow');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
      } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
      }
    };
    
    section.appendChild(header);
    section.appendChild(content);
    list.appendChild(section);
  }

  panel.classList.add('open');
}

    
            function createOrderCard(order, canCancel) {
  const statusText = {
    'received': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
    'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
    'ready': 'Ø¬Ø§Ù‡Ø²',
    'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
    'cancelled': 'Ù…Ù„ØºÙŠ'
  };
  const statusClass = {
    'received': 'badge-received',
    'preparing': 'badge-preparing',
    'ready': 'badge-ready',
    'delivered': 'badge-delivered',
    'cancelled': 'badge-cancelled'
  };

  const statuses = ['received', 'preparing', 'ready', 'delivered'];
  const currentStatusIndex = statuses.indexOf(order.status) || 0;
  
  const card = document.createElement('div');
  card.className = 'order-card';
  if (order.cancelled) card.classList.add('cancelled');
  
  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø¬Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ù†Ù‚Ø§Ø· Ù…ØªØµÙ„Ø©
  let progressHTML = '<div style="margin: 16px 0; display: flex; align-items: center; justify-content: space-between;">';
  
  statuses.forEach((status, idx) => {
    const isCompleted = idx <= currentStatusIndex;
    const isLast = idx === statuses.length - 1;
    
    // Ø§Ù„Ù†Ù‚Ø·Ø©
    const dotColor = isCompleted ? 'var(--gold)' : 'var(--brown)';
    const dotSize = isCompleted ? '16px' : '12px';
    
    progressHTML += '<div style="display: flex; align-items: center; flex: 1;">';
    progressHTML += '<div style="display: flex; flex-direction: column; align-items: center; position: relative;">';
    progressHTML += '<div style="width: ' + dotSize + '; height: ' + dotSize + '; border-radius: 50%; background: ' + dotColor + '; border: 3px solid ' + (isCompleted ? 'var(--gold)' : 'var(--brown)') + '; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 2;"></div>';
    progressHTML += '<div style="font-size: 0.7rem; color: ' + (isCompleted ? 'var(--gold)' : 'var(--muted)') + '; margin-top: 6px; text-align: center; font-weight: ' + (isCompleted ? 'bold' : 'normal') + ';">' + statusText[status] + '</div>';
    progressHTML += '</div>';
    
    // Ø§Ù„Ø®Ø· Ø§Ù„Ù…ÙˆØµÙ„ (Ø¥Ù„Ø§ ÙÙŠ Ø¢Ø®Ø± Ø¹Ù†ØµØ±)
    if (!isLast) {
      const lineColor = (idx < currentStatusIndex) ? 'var(--gold)' : 'var(--brown)';
      progressHTML += '<div style="flex: 1; height: 3px; background: ' + lineColor + '; margin: 0 4px; margin-bottom: 20px;"></div>';
    }
    
    progressHTML += '</div>';
  });
  
  progressHTML += '</div>';
  
  let detailsHTML = '<div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">';
  
  if (order.cancelled) {
    detailsHTML += '<div style="color: var(--danger); margin-bottom: 8px;"><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:</strong> ' + (order.cancelReason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</div>';
  }
  
  if (order.items && order.items.length > 0) {
    detailsHTML += '<div style="margin-bottom: 12px;">';
    order.items.forEach(i => {
      detailsHTML += '<div>' + i.name + ' Ã— ' + i.qty + ' = ' + (i.price * i.qty) + ' Ø¬</div>';
    });
    detailsHTML += '</div>';
  }
  
  detailsHTML += '<div style="font-size: 1.2rem; font-weight: bold; color: var(--gold);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + order.total + ' Ø¬</div>';
  detailsHTML += '<div class="small" style="margin-top: 8px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' + order.customer.address + '</div>';
  detailsHTML += '</div>';
  
  if (canCancel && order.status !== 'delivered' && !order.cancelled) {
    detailsHTML += '<button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="requestCancelOrder(\'' + order.id + '\')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>';
  }
  
  card.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: center;"><div><strong>Ø·Ù„Ø¨ #' + order.receiptNo + '</strong><div class="small">' + order.createdAt + '</div></div><span class="badge ' + statusClass[order.status || 'received'] + '">' + statusText[order.status || 'received'] + '</span></div>' + progressHTML + '<div class="order-details" id="user-order-' + order.id + '">' + detailsHTML + '</div>';
  
  card.onclick = (e) => {
    if (e.target.tagName !== 'BUTTON') {
      const details = document.getElementById('user-order-' + order.id);
      details.classList.toggle('open');
    }
  };
  
  return card;
}

    window.requestCancelOrder = function(orderId) {
  const order = userOrders.find(o => o.id === orderId);
  if (!order) return;
  
  if (order.status === 'delivered') {
    notify('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
    return;
  }
  
  orderToCancel = orderId;
  document.getElementById('cancelModal').classList.add('open');
};

    function confirmCancelOrder() {
  if (!orderToCancel) return;
  
  const reason = document.getElementById('cancelReason').value.trim();
  if (!reason) {
    notify('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
    return;
  }

  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  let order = orders.find(o => o.id === orderToCancel);
  
  if (order) {
    order.cancelled = true;
    order.cancelReason = reason;
    order.status = 'cancelled';
    
    // ØªØ­Ø¯ÙŠØ« Firebase
    database.ref('orders/' + orderToCancel).update({
      cancelled: true,
      cancelReason: reason,
      status: 'cancelled'
    });

    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ History
    if (!orderHistory.find(h => h.id === order.id)) {
      orderHistory.unshift(order);
      database.ref('history/' + orderToCancel).set(order);
    }

    saveState();
    syncUserOrders();
  }

  document.getElementById('cancelModal').classList.remove('open');
  document.getElementById('cancelReason').value = '';
  orderToCancel = null;
  
  notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'info');
  
  // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  setTimeout(() => {
    showMyOrders();
  }, 300);
}

    function renderOffers() {
      const select = document.getElementById('applyOffer');
      select.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
      offers.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = `${o.name} â€” ${o.discount}%`;
        select.appendChild(opt);
      });

      if (isEpotAuth) {
        const list = document.getElementById('offersList');
        if (list) {
          list.innerHTML = '';
          offers.forEach(o => {
            const div = document.createElement('div');
            div.className = 'stat-card';
            div.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${o.name}</strong>
                  <div class="small">Ø®ØµÙ… ${o.discount}%</div>
                </div>
                <button class="btn btn-danger" style="padding: 8px 16px;" onclick="removeOffer('${o.id}')">Ø­Ø°Ù</button>
              </div>
            `;
            list.appendChild(div);
          });
        }
      }
    }

    function createOffer() {
      const name = document.getElementById('offerName').value.trim();
      const discount = Number(document.getElementById('offerDiscount').value);

      if (!name || isNaN(discount) || discount < 0 || discount > 100) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }

      const id = generateId('offer');
      const newOffer = { id, name, discount };
      offers.push(newOffer);

      database.ref('offers/' + id).set(newOffer);
      saveState();

      document.getElementById('offerName').value = '';
      document.getElementById('offerDiscount').value = '';

      renderOffers();
      notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶', 'info');
    }

    window.removeOffer = function(id) {
      offers = offers.filter(o => o.id !== id);
      database.ref('offers/' + id).remove();
      saveState();
      renderOffers();
      notify('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶', 'info');
    };

    function renderOrders(filtered = null) {
      const grid = document.getElementById('ordersGrid');
      if (!grid) return;

      const ordersToShow = filtered || orders.filter(o => !o.cancelled && o.status !== 'delivered');
      
      grid.innerHTML = '';
      if (ordersToShow.length === 0) {
        grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
        return;
      }

      ordersToShow.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        const statusText = {
          'received': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
          'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
          'ready': 'Ø¬Ø§Ù‡Ø²',
          'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'
        };
        const statusClass = {
          'received': 'badge-received',
          'preparing': 'badge-preparing',
          'ready': 'badge-ready',
          'delivered': 'badge-delivered'
        };
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
              <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
              <div class="small">${order.createdAt}</div>
            </div>
            <span class="badge ${statusClass[order.status]}">${statusText[order.status]}</span>
          </div>
          <div class="order-details" id="details-${order.id}">
            <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
              <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
              <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
              ${order.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes}</div>` : ''}
              <div style="margin-top: 12px;">
                ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
              </div>
              <div style="margin-top: 8px; font-size: 1.2rem; font-weight: bold; color: var(--gold);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${order.total} Ø¬</div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
              ${order.status === 'received' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'preparing')">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>` : ''}
              ${order.status === 'preparing' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'ready')">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>` : ''}
              ${order.status === 'ready' ? `<button class="btn btn-primary" onclick="changeStatus('${order.id}', 'delivered')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : ''}
              <button class="btn btn-secondary" onclick="printReceipt(orders.find(o => o.id === '${order.id}'))">Ø·Ø¨Ø§Ø¹Ø©</button>
              <button class="btn btn-danger" onclick="cancelOrderOperator('${order.id}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
          </div>
        `;
        card.onclick = (e) => {
          if (e.target.tagName !== 'BUTTON') {
            const details = document.getElementById(`details-${order.id}`);
            details.classList.toggle('open');
          }
        };
        grid.appendChild(card);
      });

      updateStats();
    }

    window.changeStatus = function(orderId, newStatus) {
  const orderIndex = orders.findIndex(o => o.id === orderId);
  if (orderIndex === -1) return;

  const order = orders[orderIndex];
  order.status = newStatus;
  
  if (newStatus === 'delivered') {
    // Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
    if (!orderHistory.find(h => h.id === order.id)) {
      orderHistory.unshift(order);
      database.ref('history/' + orderId).set(order);
    }
    
    // Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    orders.splice(orderIndex, 1);
    database.ref('orders/' + orderId).remove();
  } else {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù
    database.ref('orders/' + orderId).update({ status: newStatus });
  }
  
  saveState();
  renderOrders();
  syncUserOrders();
  notify(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨`, 'info');
};

    window.cancelOrderOperator = function(orderId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;

      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      order.cancelled = true;
      order.cancelReason = 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´ØºÙ„';
      order.status = 'cancelled';

      database.ref('orders/' + orderId).update({ 
        cancelled: true, 
        cancelReason: 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´ØºÙ„',
        status: 'cancelled'
      });

      if (!orderHistory.find(h => h.id === order.id)) {
        orderHistory.unshift(order);
        database.ref('history/' + orderId).set(order);
      }

      saveState();
      renderOrders();
      syncUserOrders();
      notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨', 'info');
    };

    function searchOrders() {
      const address = document.getElementById('searchOrderAddress').value.trim().toLowerCase();
      const phone = document.getElementById('searchOrderPhone').value.trim();
      const orderId = document.getElementById('searchOrderId').value.trim();
      const name = document.getElementById('searchOrderName').value.trim().toLowerCase();

      const filtered = orders.filter(o => {
        if (o.cancelled) return false;
        if (address && !o.customer.address.toLowerCase().includes(address)) return false;
        if (phone && !o.customer.phone.includes(phone)) return false;
        if (orderId && !String(o.receiptNo).includes(orderId)) return false;
        if (name && !o.customer.name.toLowerCase().includes(name)) return false;
        return true;
      });

      renderOrders(filtered);
    }

    function renderHistory(filtered = null) {
      const grid = document.getElementById('historyGrid');
      if (!grid) return;

      const historyToShow = filtered || orderHistory;

      grid.innerHTML = '';
      if (historyToShow.length === 0) {
        grid.innerHTML = '<div class="small" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
        return;
      }

      historyToShow.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        if (order.cancelled) card.classList.add('cancelled');
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Ø·Ù„Ø¨ #${order.receiptNo}</strong>
              ${order.cancelled ? '<span class="badge badge-cancelled">Ù…Ù„ØºÙŠ</span>' : ''}
              <div class="small">${order.customer.name} â€” ${order.customer.phone}</div>
              <div class="small">${order.createdAt}</div>
            </div>
            <div style="font-weight: bold; color: var(--gold);">${order.total} Ø¬</div>
          </div>
          <div class="order-details" id="hist-${order.id}">
            <div style="margin-top: 12px; padding: 12px; background: var(--brown-dark); border-radius: 8px;">
              <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.customer.address}</div>
              <div><strong>Ø§Ù„Ø¯ÙØ¹:</strong> ${order.payment}</div>
              ${order.cancelled && order.cancelReason ? `<div style="color: var(--danger);"><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:</strong> ${order.cancelReason}</div>` : ''}
              ${!order.cancelled && order.items && order.items.length > 0 ? `
                <div style="margin-top: 12px;">
                  ${order.items.map(i => `<div>${i.name} Ã— ${i.qty} = ${i.price * i.qty} Ø¬</div>`).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
        card.onclick = () => {
          const details = document.getElementById(`hist-${order.id}`);
          details.classList.toggle('open');
        };
        grid.appendChild(card);
      });
    }

    function searchHistory() {
      const address = document.getElementById('searchAddress').value.trim().toLowerCase();
      const phone = document.getElementById('searchPhone').value.trim();
      const orderId = document.getElementById('searchOrderIdHist').value.trim();
      const name = document.getElementById('searchName').value.trim().toLowerCase();

      const filtered = orderHistory.filter(o => {
        if (address && !o.customer.address.toLowerCase().includes(address)) return false;
        if (phone && !o.customer.phone.includes(phone)) return false;
        if (orderId && !String(o.receiptNo).includes(orderId)) return false;
        if (name && !o.customer.name.toLowerCase().includes(name)) return false;
        return true;
      });

      renderHistory(filtered);
    }

    function endDay() {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©
  const activeOrders = orders.filter(o => !o.cancelled && o.status !== 'delivered');
  
  if (activeOrders.length > 0) {
    notify('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…! ÙŠÙˆØ¬Ø¯ ' + activeOrders.length + ' Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'error');
    return;
  }
  
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.')) return;

  orders.forEach(order => {
    if (!orderHistory.find(h => h.id === order.id)) {
      orderHistory.unshift(order);
      database.ref('history/' + order.id).set(order);
    }
    database.ref('orders/' + order.id).remove();
  });

  orders = [];
  saveState();
  renderOrders();
  renderHistory();
  renderEpotHistory();
  notify('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­', 'info');
}

    function updateStats() {
      if (!isEpotAuth) return;

      const totalRev = document.getElementById('totalRevenue');
      const todayOrd = document.getElementById('todayOrders');
      const todayRev = document.getElementById('todayRevenue');

      if (totalRev && todayOrd && todayRev) {
        const allRevenue = orderHistory.filter(o => !o.cancelled).reduce((sum, o) => sum + o.total, 0);
        totalRev.textContent = `${allRevenue} Ø¬`;

        const today = new Date().toDateString();
        const todayOrders = [...orders, ...orderHistory].filter(o => o.date === today && !o.cancelled);
        todayOrd.textContent = todayOrders.length;
        todayRev.textContent = `${todayOrders.reduce((s, o) => s + o.total, 0)} Ø¬`;
      }
    }

    function renderItemManagement() {
      const list = document.getElementById('manageItemsList');
      if (!list) return;

      const catSelect = document.getElementById('newItemCategory');
      catSelect.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
      });

      list.innerHTML = '';
      Object.keys(menu).forEach(cat => {
        const section = document.createElement('div');
        section.style.marginBottom = '20px';
        section.innerHTML = `<h4 style="color: var(--gold); margin-bottom: 12px;">${cat}</h4>`;
        
        menu[cat].forEach(item => {
          const div = document.createElement('div');
          div.className = 'stat-card';
          div.style.marginBottom = '8px';
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${item.name}</strong>
                <div class="small">${item.price} Ø¬ â€” Ù…Ø¨ÙŠØ¹Ø§Øª: ${item.sold || 0}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn ${item.available ? 'btn-secondary' : 'btn-primary'}" style="padding: 6px 12px;" onclick="toggleAvailability('${item.id}')">
                  ${item.available ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±'}
                </button>
                <button class="btn btn-danger" style="padding: 6px 12px;" onclick="deleteItem('${item.id}')">Ø­Ø°Ù</button>
              </div>
            </div>
          `;
          section.appendChild(div);
        });
        
        list.appendChild(section);
      });
    }

    function addNewItem() {
      const name = document.getElementById('newItemName').value.trim();
      const price = Number(document.getElementById('newItemPrice').value);
      const category = document.getElementById('newItemCategory').value;

      if (!name || isNaN(price) || price < 0 || !category) {
        notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©', 'warning');
        return;
      }

      const id = generateId('item');
      const newItem = { id, name, price, available: true, sold: 0 };

      if (!menu[category]) menu[category] = [];
      menu[category].push(newItem);

      database.ref('menu').set(menu);
      saveState();

      document.getElementById('newItemName').value = '';
      document.getElementById('newItemPrice').value = '';

      renderMenu();
      renderCategories();
      renderItemManagement();
      notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù', 'info');
    }

    window.toggleAvailability = function(itemId) {
      const item = findItemById(itemId);
      if (!item) return;

      item.available = !item.available;
      database.ref('menu').set(menu);
      saveState();

      renderMenu();
      renderItemManagement();
      notify(`ØªÙ… ${item.available ? 'Ø¥Ø¸Ù‡Ø§Ø±' : 'Ø¥Ø®ÙØ§Ø¡'} Ø§Ù„ØµÙ†Ù`, 'info');
    };

    window.deleteItem = function(itemId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) return;

      for (const cat in menu) {
        menu[cat] = menu[cat].filter(i => i.id !== itemId);
      }

      database.ref('menu').set(menu);
      saveState();

      renderMenu();
      renderCategories();
      renderItemManagement();
      notify('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù', 'info');
    };

    function exportData() {
      const data = {
        menu,
        orders,
        orderHistory,
        offers,
        exportDate: new Date().toLocaleString('ar-EG')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `koshary-data-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      notify('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
    }

    function setupEventListeners() {
  document.getElementById('cartToggle').onclick = () => {
    document.getElementById('cartPanel').classList.add('open');
  };

  document.getElementById('closeCart').onclick = () => {
    document.getElementById('cartPanel').classList.remove('open');
  };

  document.getElementById('closeOrders').onclick = () => {
    document.getElementById('ordersPanel').classList.remove('open');
  };

  document.getElementById('clearCartBtn').onclick = () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ')) {
      cart = [];
      updateCartDisplay();
    }
  };

  document.getElementById('searchEpotBtn').onclick = searchEpotHistory;

  document.getElementById('checkoutBtn').onclick = openCheckout;
      document.getElementById('confirmOrderBtn').onclick = confirmOrder;
      document.getElementById('cancelCheckoutBtn').onclick = () => {
        document.getElementById('checkoutSection').style.display = 'none';
      };

      document.getElementById('applyOffer').onchange = updateCartDisplay;

      document.getElementById('profileBtn').onclick = () => {
        const menu = document.getElementById('profileMenu');
        menu.classList.toggle('open');
      };

      document.getElementById('trackOrdersBtn').onclick = () => {
        document.getElementById('profileMenu').classList.remove('open');
        showMyOrders();
      };

      document.getElementById('sendOtpBtn').onclick = () => {
        sendOtp();
      };

      document.getElementById('skipOtpBtn').onclick = () => {
        document.getElementById('otpModal').classList.remove('open');
        processOrder(false);
      };

      document.getElementById('verifyOtpBtn').onclick = () => {
        verifyOtp();
      };

      document.getElementById('resendOtpBtn').onclick = () => {
        sendOtp();
        notify('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯', 'info');
      };

      document.getElementById('confirmCancelBtn').onclick = confirmCancelOrder;
      
      document.getElementById('closeCancelBtn').onclick = () => {
        document.getElementById('cancelModal').classList.remove('open');
        document.getElementById('cancelReason').value = '';
        orderToCancel = null;
      };

           // Ø¯Ø§Ø®Ù„ setupEventListenersØŒ Ø£Ø¶Ù:
document.getElementById('confirmCancelBtn').onclick = confirmCancelOrder;

document.getElementById('closeCancelBtn').onclick = () => {
  document.getElementById('cancelModal').classList.remove('open');
  document.getElementById('cancelReason').value = '';
  orderToCancel = null;
};
      document.addEventListener('keydown', (e) => {
        if (currentView === 'customer') {
          secretCode += e.key;
          if (secretCode.length > 20) {
            secretCode = secretCode.slice(-20);
          }
          if (secretCode.includes('admin123')) {
            secretCode = '';
            isOperatorAuth = true;
            showOperatorView();
          }
        }
      });

      document.getElementById('logoutBtn').onclick = () => {
        isOperatorAuth = false;
        isEpotAuth = false;
        secretCode = '';
        showCustomerView();
      };

      document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = (e) => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
          
          e.target.classList.add('active');
          const tabName = e.target.dataset.tab;
          document.getElementById(tabName + 'Content').classList.add('active');

          if (tabName === 'history') renderHistory();
          if (tabName === 'orders') renderOrders();
        };
      });

      document.getElementById('searchOrderBtn').onclick = searchOrders;
      document.getElementById('searchBtn').onclick = searchHistory;

      document.getElementById('openEpotBtn').onclick = () => {
        document.getElementById('epotModal').classList.add('open');
      };

      document.getElementById('cancelEpotBtn').onclick = () => {
        document.getElementById('epotModal').classList.remove('open');
      };

      document.getElementById('submitEpotBtn').onclick = () => {
        const pwd = document.getElementById('epotPassword').value;
        if (pwd === epotPassword) {
          isEpotAuth = true;
          document.getElementById('epotModal').classList.remove('open');
          showEpotPanel();
        } else {
          notify('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©', 'error');
        }
        document.getElementById('epotPassword').value = '';
      };

      document.getElementById('lockEpotBtn').onclick = () => {
        isEpotAuth = false;
        document.getElementById('epotUnlocked').style.display = 'none';
        document.getElementById('epotLocked').style.display = 'block';
      };

      document.getElementById('setEpotPwdBtn').onclick = () => {
        const newPwd = document.getElementById('newEpotPwd').value.trim();
        if (!newPwd) {
          notify('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±', 'warning');
          return;
        }
        epotPassword = newPwd;
        localStorage.setItem(LS_KEYS.EPOT_PWD, epotPassword);
        document.getElementById('newEpotPwd').value = '';
        notify('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'info');
      };

      document.getElementById('addItemBtn').onclick = addNewItem;
      document.getElementById('createOfferBtn').onclick = createOffer;
      document.getElementById('exportDataBtn').onclick = exportData;
      document.getElementById('endDayBtn').onclick = endDay;

      document.getElementById('autoPrintCheckbox').onchange = (e) => {
        autoPrint = e.target.checked;
        saveState();
        notify(autoPrint ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©', 'info');
      };

      document.addEventListener('click', (e) => {
        const profileMenu = document.getElementById('profileMenu');
        const profileBtn = document.getElementById('profileBtn');
        if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
          profileMenu.classList.remove('open');
        }
      });
    }

    function showCustomerView() {
  currentView = 'customer';
  sessionStorage.setItem('currentView', 'customer');
  sessionStorage.setItem('isOperatorAuth', 'false');
  sessionStorage.setItem('isEpotAuth', 'false');
  
  document.getElementById('operatorDashboard').style.display = 'none';
  document.getElementById('menuContainer').style.display = 'block';
  document.querySelector('.header').style.position = 'fixed';
  document.querySelector('.categories-section').style.display = 'block';
  document.getElementById('cartToggle').style.display = 'flex';
  document.getElementById('customerStatus').style.display = 'none';
  checkCustomerOrders();
}

function updateOperatorBadge() {
  const activeOrders = orders.filter(o => !o.cancelled && o.status !== 'delivered');
  // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© badge Ù„Ù„Ù…Ø´ØºÙ„ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
}

    function showOperatorView() {
  currentView = 'operator';
  sessionStorage.setItem('currentView', 'operator');
  sessionStorage.setItem('isOperatorAuth', 'true');
  
  document.getElementById('menuContainer').style.display = 'none';
  document.querySelector('.categories-section').style.display = 'none';
  document.getElementById('cartToggle').style.display = 'none';
  document.getElementById('cartPanel').classList.remove('open');
  document.getElementById('ordersPanel').classList.remove('open');
  document.getElementById('checkoutSection').style.display = 'none';
  document.getElementById('customerStatus').style.display = 'none';
  
  document.getElementById('operatorDashboard').style.display = 'block';
  document.querySelector('.header').style.position = 'fixed';
  renderOrders();
  renderHistory();
  updateOperatorBadge();
}

    function showEpotPanel() {
  sessionStorage.setItem('isEpotAuth', 'true');
  document.getElementById('epotLocked').style.display = 'none';
  document.getElementById('epotUnlocked').style.display = 'block';
  updateStats();
  renderItemManagement();
  renderOffers();
  renderEpotHistory();
} 
  </script>
</body>
</html>
